<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema LSAF - Fuerza Aérea</title>
    <style>
        :root {
            --airforce-blue: #00308F;
            --airforce-light: #5072A7;
            --airforce-gold: #B8860B;
            --airforce-white: #FFFFFF;
            --airforce-gray: #F0F0F0;
            --airforce-dark: #002244;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: var(--airforce-gray);
            color: #333;
        }
        
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background: linear-gradient(135deg, var(--airforce-blue) 0%, var(--airforce-dark) 100%);
        }
        
        .login-form {
            background-color: var(--airforce-white);
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            width: 100%;
            max-width: 400px;
        }
        
        .login-form h1 {
            color: var(--airforce-blue);
            text-align: center;
            margin-bottom: 1.5rem;
            font-size: 1.8rem;
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }
        
        .btn {
            display: inline-block;
            padding: 0.75rem 1.5rem;
            background-color: var(--airforce-blue);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            text-align: center;
            transition: background-color 0.3s;
        }
        
        .btn:hover {
            background-color: var(--airforce-dark);
        }
        
        .btn-block {
            display: block;
            width: 100%;
        }
        
        .btn-success {
            background-color: #28a745;
        }
        
        .btn-danger {
            background-color: #dc3545;
        }
        
        .btn-warning {
            background-color: #ffc107;
            color: #212529;
        }
        
        .app-container {
            display: none;
        }
        
        .header {
            background-color: var(--airforce-blue);
            color: white;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .nav-tabs {
            display: flex;
            background-color: var(--airforce-light);
            padding: 0;
            overflow-x: auto;
        }
        
        .nav-tab {
            padding: 1rem 1.5rem;
            color: white;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            white-space: nowrap;
        }
        
        .nav-tab.active {
            background-color: var(--airforce-white);
            color: var(--airforce-blue);
            border-bottom: 3px solid var(--airforce-gold);
        }
        
        .content {
            padding: 2rem;
        }
        
        .page {
            display: none;
        }
        
        .page.active {
            display: block;
        }
        
        .card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 1.5rem;
            padding: 1.5rem;
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            border-bottom: 1px solid #eee;
            padding-bottom: 1rem;
        }
        
        .piloto-item {
            display: flex;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid #eee;
            transition: background-color 0.2s;
        }
        
        .piloto-item:hover {
            background-color: #f8f9fa;
        }
        
        .piloto-item:last-child {
            border-bottom: none;
        }
        
        .piloto-insignia {
            width: 50px;
            height: 50px;
            margin-right: 1rem;
            background-color: #f0f0f0;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: var(--airforce-blue);
        }
        
        .piloto-info {
            flex-grow: 1;
        }
        
        .piloto-nombre {
            font-weight: 600;
            font-size: 1.1rem;
        }
        
        .piloto-nuim {
            font-size: 0.9rem;
            color: #666;
        }
        
        .piloto-rango {
            font-size: 0.9rem;
            color: var(--airforce-blue);
            font-weight: 500;
        }
        
        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-top: 1rem;
        }
        
        .grid-item {
            background: white;
            border-radius: 8px;
            padding: 1rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid #eee;
            padding-bottom: 1rem;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
        }
        
        .form-row {
            display: flex;
            flex-wrap: wrap;
            margin: 0 -0.5rem;
        }
        
        .form-col {
            flex: 1;
            padding: 0 0.5rem;
            min-width: 200px;
        }
        
        .embed-box {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        .embed-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--airforce-blue);
        }
        
        .error-message {
            color: #d32f2f;
            font-size: 0.9rem;
            margin-top: 0.25rem;
        }
        
        .success-message {
            color: #28a745;
            font-size: 0.9rem;
            margin-top: 0.25rem;
        }
        
        .loading {
            text-align: center;
            padding: 2rem;
            color: #666;
        }
        
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }
        
        .stat-card {
            background: linear-gradient(135deg, var(--airforce-blue) 0%, var(--airforce-light) 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
        
        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }
    </style>
</head>
<body>
    <!-- Página de inicio de sesión -->
    <div class="login-container" id="loginPage">
        <div class="login-form">
            <h1>Sistema LSAF</h1>
            <form id="loginForm">
                <div class="form-group">
                    <label for="email">Correo electrónico</label>
                    <input type="email" id="email" required value="david_toro@lsaf.gov.us">
                </div>
                <div class="form-group">
                    <label for="password">Contraseña</label>
                    <input type="password" id="password" required value="12345">
                </div>
                <button type="submit" class="btn btn-block">Iniciar sesión</button>
            </form>
        </div>
    </div>
    
    <!-- Aplicación principal (oculta inicialmente) -->
    <div class="app-container" id="appContainer">
        <header class="header">
            <h1>Fuerza Aérea LSAF</h1>
            <div>
                <span id="userName">Usuario</span>
                <button class="btn" id="logoutBtn" style="margin-left: 1rem;">Cerrar sesión</button>
            </div>
        </header>
        
        <nav class="nav-tabs">
            <div class="nav-tab active" data-page="pilotos">Pilotos</div>
            <div class="nav-tab" data-page="aeronaves">Aeronaves</div>
            <div class="nav-tab" data-page="libros-vuelo">Libros de Vuelo</div>
            <div class="nav-tab" data-page="solicitudes">Solicitudes</div>
            <div class="nav-tab" data-page="resumen">Resumen</div>
            <div class="nav-tab" data-page="rangos">Rangos</div>
        </nav>
        
        <main class="content">
            <!-- Página de Pilotos -->
            <div class="page active" id="pilotosPage">
                <div class="card">
                    <div class="card-header">
                        <h2>Lista de Pilotos</h2>
                        <button class="btn" id="addPilotoBtn">Agregar Piloto</button>
                    </div>
                    <div id="pilotosList" class="loading">
                        Cargando pilotos...
                    </div>
                </div>
            </div>
            
            <!-- Página de Aeronaves -->
            <div class="page" id="aeronavesPage">
                <div class="card">
                    <div class="card-header">
                        <h2>Aeronaves</h2>
                        <button class="btn" id="addAeronaveBtn">Agregar Aeronave</button>
                    </div>
                    <div id="aeronavesList" class="loading">
                        Cargando aeronaves...
                    </div>
                </div>
            </div>
            
            <!-- Página de Libros de Vuelo -->
            <div class="page" id="librosVueloPage">
                <div class="card">
                    <div class="card-header">
                        <h2>Libros de Vuelo</h2>
                        <button class="btn" id="addLibroVueloBtn">Registrar Libro de Vuelo</button>
                    </div>
                    <div id="librosVueloList" class="loading">
                        Cargando libros de vuelo...
                    </div>
                </div>
            </div>
            
            <!-- Página de Solicitudes -->
            <div class="page" id="solicitudesPage">
                <div class="card">
                    <div class="card-header">
                        <h2>Solicitudes de Certificación</h2>
                        <button class="btn" id="addSolicitudBtn">Solicitar Certificación</button>
                    </div>
                    <div id="solicitudesList" class="loading">
                        Cargando solicitudes...
                    </div>
                </div>
            </div>
            
            <!-- Página de Resumen -->
            <div class="page" id="resumenPage">
                <div class="card">
                    <div class="card-header">
                        <h2>Resumen General</h2>
                    </div>
                    <div id="resumenContent" class="loading">
                        Cargando resumen...
                    </div>
                </div>
            </div>
            
            <!-- Página de Rangos -->
            <div class="page" id="rangosPage">
                <div class="card">
                    <div class="card-header">
                        <h2>Rangos</h2>
                        <button class="btn" id="addRangoBtn">Agregar Rango</button>
                    </div>
                    <div id="rangosList" class="loading">
                        Cargando rangos...
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Modal para agregar/editar piloto -->
    <div class="modal" id="pilotoModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="pilotoModalTitle">Agregar Piloto</h2>
                <button class="close-modal">&times;</button>
            </div>
            <form id="pilotoForm">
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label for="pilotoNombre">Piloto *</label>
                            <input type="text" id="pilotoNombre" required>
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label for="pilotoEmail">Email *</label>
                            <input type="email" id="pilotoEmail" required>
                        </div>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label for="pilotoNUIM">NUIM *</label>
                            <input type="text" id="pilotoNUIM" required placeholder="Formato: 10-291992">
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label for="pilotoFechaIngreso">Fecha de Ingreso *</label>
                            <input type="date" id="pilotoFechaIngreso" required>
                        </div>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label for="pilotoRol">Rol *</label>
                            <select id="pilotoRol" required>
                                <option value="">Seleccionar</option>
                                <option value="ADMIN">ADMIN</option>
                                <option value="INSTRUCTOR">INSTRUCTOR</option>
                                <option value="PILOTO">PILOTO</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label for="pilotoEstado">Estado *</label>
                            <select id="pilotoEstado" required>
                                <option value="ACTIVO">ACTIVO</option>
                                <option value="ARCHIVADO">ARCHIVADO</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <button type="submit" class="btn">Guardar Piloto</button>
                    <button type="button" class="btn" id="cancelPilotoBtn" style="background-color: #666; margin-left: 0.5rem;">Cancelar</button>
                </div>
                <div id="pilotoMessage"></div>
            </form>
        </div>
    </div>

    <!-- Modal para agregar aeronave -->
    <div class="modal" id="aeronaveModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Agregar Aeronave</h2>
                <button class="close-modal">&times;</button>
            </div>
            <form id="aeronaveForm">
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label for="aeronaveCallsign">Callsign *</label>
                            <input type="text" id="aeronaveCallsign" required>
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label for="aeronaveModelo">Modelo *</label>
                            <input type="text" id="aeronaveModelo" required>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <button type="submit" class="btn">Guardar Aeronave</button>
                    <button type="button" class="btn" id="cancelAeronaveBtn" style="background-color: #666; margin-left: 0.5rem;">Cancelar</button>
                </div>
                <div id="aeronaveMessage"></div>
            </form>
        </div>
    </div>

    <script>
        // URL de tu Google Apps Script
        const API_URL = 'https://script.google.com/macros/s/AKfycbynL-J1wbCLPPkCwqscFgqPbTth9CEszyttcVaDM8_81LkeH_Yv50yFctWV1UjYqmWsZg/exec';
        
        // Variables globales
        let currentUser = null;
        let appData = {
            pilotos: [],
            aeronaves: [],
            librosVuelo: [],
            solicitudes: [],
            rangos: [],
            lideres: []
        };
        
        // Elementos del DOM
        const loginPage = document.getElementById('loginPage');
        const appContainer = document.getElementById('appContainer');
        const loginForm = document.getElementById('loginForm');
        const logoutBtn = document.getElementById('logoutBtn');
        const navTabs = document.querySelectorAll('.nav-tab');
        const pages = document.querySelectorAll('.page');
        
        // Inicialización
        document.addEventListener('DOMContentLoaded', function() {
            checkSession();
            setupEventListeners();
        });
        
        function checkSession() {
            const userSession = localStorage.getItem('lsaf_user');
            if (userSession) {
                currentUser = JSON.parse(userSession);
                showApp();
            }
        }
        
        function setupEventListeners() {
            // Inicio de sesión
            loginForm.addEventListener('submit', handleLogin);
            
            // Cerrar sesión
            logoutBtn.addEventListener('click', handleLogout);
            
            // Navegación entre pestañas
            navTabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const pageId = this.getAttribute('data-page');
                    switchPage(pageId);
                });
            });
            
            // Botones para agregar elementos
            document.getElementById('addPilotoBtn').addEventListener('click', () => showModal('pilotoModal'));
            document.getElementById('addAeronaveBtn').addEventListener('click', () => showModal('aeronaveModal'));
            document.getElementById('addLibroVueloBtn').addEventListener('click', () => alert('Funcionalidad de libro de vuelo en desarrollo'));
            document.getElementById('addSolicitudBtn').addEventListener('click', () => alert('Funcionalidad de solicitud en desarrollo'));
            document.getElementById('addRangoBtn').addEventListener('click', () => alert('Funcionalidad de rangos en desarrollo'));
            
            // Botones de cancelar
            document.getElementById('cancelPilotoBtn').addEventListener('click', () => hideModal('pilotoModal'));
            document.getElementById('cancelAeronaveBtn').addEventListener('click', () => hideModal('aeronaveModal'));
            
            // Cerrar modales
            document.querySelectorAll('.close-modal').forEach(btn => {
                btn.addEventListener('click', function() {
                    const modal = this.closest('.modal');
                    hideModal(modal.id);
                });
            });
            
            // Formularios
            document.getElementById('pilotoForm').addEventListener('submit', savePiloto);
            document.getElementById('aeronaveForm').addEventListener('submit', saveAeronave);
        }
        
        async function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            try {
                const response = await fetch(`${API_URL}?action=login&email=${encodeURIComponent(email)}&password=${encodeURIComponent(password)}`);
                const data = await response.json();
                
                if (data.success) {
                    currentUser = data.user;
                    localStorage.setItem('lsaf_user', JSON.stringify(currentUser));
                    showApp();
                } else {
                    showMessage('loginForm', data.error, 'error');
                }
            } catch (error) {
                showMessage('loginForm', 'Error de conexión: ' + error.message, 'error');
            }
        }
        
        function handleLogout() {
            localStorage.removeItem('lsaf_user');
            currentUser = null;
            hideApp();
        }
        
        function showApp() {
            loginPage.style.display = 'none';
            appContainer.style.display = 'block';
            document.getElementById('userName').textContent = currentUser.nombre;
            
            // Cargar datos iniciales
            loadInitialData();
        }
        
        function hideApp() {
            appContainer.style.display = 'none';
            loginPage.style.display = 'flex';
            // Limpiar formularios
            document.getElementById('loginForm').reset();
        }
        
        function switchPage(pageId) {
            // Quitar clase active de todas las pestañas y páginas
            navTabs.forEach(tab => tab.classList.remove('active'));
            pages.forEach(page => page.classList.remove('active'));
            
            // Activar la pestaña y página seleccionada
            document.querySelector(`.nav-tab[data-page="${pageId}"]`).classList.add('active');
            document.getElementById(`${pageId}Page`).classList.add('active');
            
            // Cargar datos específicos de la página si es necesario
            loadPageData(pageId);
        }
        
        async function loadInitialData() {
            try {
                // Cargar datos básicos necesarios para la aplicación
                await Promise.all([
                    loadPilotos(),
                    loadAeronaves(),
                    loadRangos()
                ]);
                
                // Mostrar la página de pilotos por defecto
                displayPilotos();
            } catch (error) {
                console.error('Error cargando datos iniciales:', error);
            }
        }
        
        async function loadPageData(pageId) {
            try {
                switch(pageId) {
                    case 'pilotos':
                        await loadPilotos();
                        displayPilotos();
                        break;
                    case 'aeronaves':
                        await loadAeronaves();
                        displayAeronaves();
                        break;
                    case 'libros-vuelo':
                        await loadLibrosVuelo();
                        displayLibrosVuelo();
                        break;
                    case 'solicitudes':
                        await loadSolicitudes();
                        displaySolicitudes();
                        break;
                    case 'resumen':
                        await loadResumen();
                        displayResumen();
                        break;
                    case 'rangos':
                        await loadRangos();
                        displayRangos();
                        break;
                }
            } catch (error) {
                console.error(`Error cargando datos de ${pageId}:`, error);
                document.getElementById(`${pageId}List`).innerHTML = `<p class="error-message">Error cargando datos: ${error.message}</p>`;
            }
        }
        
        async function loadPilotos() {
            const response = await fetch(`${API_URL}?action=getPilotos`);
            const data = await response.json();
            if (data.error) throw new Error(data.error);
            appData.pilotos = data.pilotos || [];
        }
        
        async function loadAeronaves() {
            const response = await fetch(`${API_URL}?action=getAeronaves`);
            const data = await response.json();
            if (data.error) throw new Error(data.error);
            appData.aeronaves = data.aeronaves || [];
        }
        
        async function loadLibrosVuelo() {
            const response = await fetch(`${API_URL}?action=getLibrosVuelo`);
            const data = await response.json();
            if (data.error) throw new Error(data.error);
            appData.librosVuelo = data.libros || [];
        }
        
        async function loadSolicitudes() {
            const response = await fetch(`${API_URL}?action=getSolicitudes`);
            const data = await response.json();
            if (data.error) throw new Error(data.error);
            appData.solicitudes = data.solicitudes || [];
        }
        
        async function loadRangos() {
            const response = await fetch(`${API_URL}?action=getRangos`);
            const data = await response.json();
            if (data.error) throw new Error(data.error);
            appData.rangos = data.rangos || [];
        }
        
        async function loadResumen() {
            // Cargar todos los datos necesarios para el resumen
            await Promise.all([
                loadPilotos(),
                loadAeronaves(),
                loadLibrosVuelo(),
                loadSolicitudes()
            ]);
        }
        
        function displayPilotos() {
            const pilotosList = document.getElementById('pilotosList');
            
            if (appData.pilotos.length === 0) {
                pilotosList.innerHTML = '<p>No hay pilotos registrados.</p>';
                return;
            }
            
            pilotosList.innerHTML = '';
            
            appData.pilotos.forEach(piloto => {
                const pilotoItem = document.createElement('div');
                pilotoItem.className = 'piloto-item';
                pilotoItem.innerHTML = `
                    <div class="piloto-insignia">${piloto.rango ? piloto.rango.charAt(0) : 'P'}</div>
                    <div class="piloto-info">
                        <div class="piloto-nombre">${piloto.nombre}</div>
                        <div class="piloto-nuim">${piloto.nuim}</div>
                        <div class="piloto-rango">${piloto.rango || 'Sin rango'}</div>
                    </div>
                    <button class="btn" onclick="viewPiloto('${piloto.nuim}')">Ver</button>
                `;
                pilotosList.appendChild(pilotoItem);
            });
        }
        
        function displayAeronaves() {
            const aeronavesList = document.getElementById('aeronavesList');
            
            if (appData.aeronaves.length === 0) {
                aeronavesList.innerHTML = '<p>No hay aeronaves registradas.</p>';
                return;
            }
            
            aeronavesList.innerHTML = '<div class="grid-container"></div>';
            const gridContainer = aeronavesList.querySelector('.grid-container');
            
            appData.aeronaves.forEach(aeronave => {
                const aeronaveCard = document.createElement('div');
                aeronaveCard.className = 'grid-item';
                aeronaveCard.innerHTML = `
                    <h3>${aeronave.callsign}</h3>
                    <p><strong>Modelo:</strong> ${aeronave.modelo}</p>
                    <p><strong>Certificada:</strong> ${aeronave.certificada || 'No'}</p>
                    <button class="btn" style="margin-top: 0.5rem;" onclick="viewAeronave('${aeronave.callsign}')">Ver Detalles</button>
                `;
                gridContainer.appendChild(aeronaveCard);
            });
        }
        
        function displayLibrosVuelo() {
            const librosVueloList = document.getElementById('librosVueloList');
            
            if (appData.librosVuelo.length === 0) {
                librosVueloList.innerHTML = '<p>No hay libros de vuelo registrados.</p>';
                return;
            }
            
            librosVueloList.innerHTML = '<div class="grid-container"></div>';
            const gridContainer = librosVueloList.querySelector('.grid-container');
            
            appData.librosVuelo.forEach(libro => {
                const libroCard = document.createElement('div');
                libroCard.className = 'grid-item';
                libroCard.innerHTML = `
                    <h3>${libro.id_libro}</h3>
                    <p><strong>Piloto:</strong> ${libro.piloto}</p>
                    <p><strong>Aeronave:</strong> ${libro.aeronave}</p>
                    <p><strong>Tiempo:</strong> ${libro.tiempo_total || '0'} horas</p>
                    <button class="btn" style="margin-top: 0.5rem;" onclick="viewLibroVuelo('${libro.id_libro}')">Ver Detalles</button>
                `;
                gridContainer.appendChild(libroCard);
            });
        }
        
        function displaySolicitudes() {
            const solicitudesList = document.getElementById('solicitudesList');
            
            if (appData.solicitudes.length === 0) {
                solicitudesList.innerHTML = '<p>No hay solicitudes pendientes.</p>';
                return;
            }
            
            solicitudesList.innerHTML = '<div class="grid-container"></div>';
            const gridContainer = solicitudesList.querySelector('.grid-container');
            
            appData.solicitudes.forEach(solicitud => {
                const solicitudCard = document.createElement('div');
                solicitudCard.className = 'grid-item';
                solicitudCard.innerHTML = `
                    <h3>${solicitud.id_solicitud}</h3>
                    <p><strong>Piloto:</strong> ${solicitud.piloto}</p>
                    <p><strong>Aeronave:</strong> ${solicitud.aeronave}</p>
                    <p><strong>Estado:</strong> ${solicitud.estado || 'PENDIENTE'}</p>
                    <button class="btn" style="margin-top: 0.5rem;" onclick="viewSolicitud('${solicitud.id_solicitud}')">Ver Detalles</button>
                `;
                gridContainer.appendChild(solicitudCard);
            });
        }
        
        function displayResumen() {
            const resumenContent = document.getElementById('resumenContent');
            
            // Calcular estadísticas
            const totalPilotos = appData.pilotos.length;
            const totalAeronaves = appData.aeronaves.length;
            const totalLibrosVuelo = appData.librosVuelo.length;
            const totalSolicitudes = appData.solicitudes.length;
            
            // Calcular tiempo total de vuelo
            const tiempoTotal = appData.librosVuelo.reduce((total, libro) => {
                return total + parseFloat(libro.tiempo_total || 0);
            }, 0);
            
            resumenContent.innerHTML = `
                <div class="stats-container">
                    <div class="stat-card">
                        <div class="stat-number">${totalPilotos}</div>
                        <div class="stat-label">Pilotos Activos</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${totalAeronaves}</div>
                        <div class="stat-label">Aeronaves</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${totalLibrosVuelo}</div>
                        <div class="stat-label">Libros de Vuelo</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${totalSolicitudes}</div>
                        <div class="stat-label">Solicitudes</div>
                    </div>
                </div>
                
                <div class="card">
                    <h3>Tiempo Total de Vuelo</h3>
                    <p style="font-size: 2rem; font-weight: bold; color: var(--airforce-blue); text-align: center;">
                        ${tiempoTotal.toFixed(2)} horas
                    </p>
                </div>
                
                <div class="card">
                    <h3>Resumen por Aeronave</h3>
                    <div id="aeronavesResumen">
                        ${appData.aeronaves.map(aeronave => {
                            const tiempoAeronave = appData.librosVuelo
                                .filter(libro => libro.aeronave === aeronave.callsign)
                                .reduce((total, libro) => total + parseFloat(libro.tiempo_total || 0), 0);
                            
                            return `
                                <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid #eee;">
                                    <span>${aeronave.callsign} (${aeronave.modelo})</span>
                                    <span><strong>${tiempoAeronave.toFixed(2)} horas</strong></span>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }
        
        function displayRangos() {
            const rangosList = document.getElementById('rangosList');
            
            if (appData.rangos.length === 0) {
                rangosList.innerHTML = '<p>No hay rangos definidos.</p>';
                return;
            }
            
            rangosList.innerHTML = '<div class="grid-container"></div>';
            const gridContainer = rangosList.querySelector('.grid-container');
            
            appData.rangos.forEach(rango => {
                const rangoCard = document.createElement('div');
                rangoCard.className = 'grid-item';
                rangoCard.innerHTML = `
                    <h3>${rango.nombre}</h3>
                    <p><strong>Abreviación:</strong> ${rango.abreviacion || 'N/A'}</p>
                    <p><strong>Escalafón:</strong> ${rango.escalafon || 'N/A'}</p>
                    <button class="btn" style="margin-top: 0.5rem;" onclick="viewRango('${rango.nombre}')">Ver Detalles</button>
                `;
                gridContainer.appendChild(rangoCard);
            });
        }
        
        function showModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }
        
        function hideModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
            // Limpiar formulario y mensajes
            const form = document.querySelector(`#${modalId} form`);
            if (form) form.reset();
            const messageDiv = document.querySelector(`#${modalId} .error-message, #${modalId} .success-message`);
            if (messageDiv) messageDiv.innerHTML = '';
        }
        
        async function savePiloto(e) {
            e.preventDefault();
            
            const pilotoData = {
                nombre: document.getElementById('pilotoNombre').value,
                email: document.getElementById('pilotoEmail').value,
                nuim: document.getElementById('pilotoNUIM').value,
                fecha_ingreso: document.getElementById('pilotoFechaIngreso').value,
                rol: document.getElementById('pilotoRol').value,
                estado: document.getElementById('pilotoEstado').value
            };
            
            try {
                // Construir URL con parámetros
                const params = new URLSearchParams();
                for (const key in pilotoData) {
                    params.append(key, pilotoData[key]);
                }
                
                const response = await fetch(`${API_URL}?action=addPiloto&${params}`);
                const data = await response.json();
                
                if (data.success) {
                    showMessage('pilotoForm', `Piloto agregado correctamente. Contraseña temporal: ${data.contraseña_temporal}`, 'success');
                    // Recargar lista de pilotos
                    await loadPilotos();
                    displayPilotos();
                    // Cerrar modal después de 2 segundos
                    setTimeout(() => hideModal('pilotoModal'), 2000);
                } else {
                    showMessage('pilotoForm', data.error, 'error');
                }
            } catch (error) {
                showMessage('pilotoForm', 'Error de conexión: ' + error.message, 'error');
            }
        }
        
        async function saveAeronave(e) {
            e.preventDefault();
            
            const aeronaveData = {
                callsign: document.getElementById('aeronaveCallsign').value,
                modelo: document.getElementById('aeronaveModelo').value
            };
            
            try {
                const params = new URLSearchParams();
                for (const key in aeronaveData) {
                    params.append(key, aeronaveData[key]);
                }
                
                const response = await fetch(`${API_URL}?action=addAeronave&${params}`);
                const data = await response.json();
                
                if (data.success) {
                    showMessage('aeronaveForm', 'Aeronave agregada correctamente', 'success');
                    await loadAeronaves();
                    displayAeronaves();
                    setTimeout(() => hideModal('aeronaveModal'), 2000);
                } else {
                    showMessage('aeronaveForm', data.error, 'error');
                }
            } catch (error) {
                showMessage('aeronaveForm', 'Error de conexión: ' + error.message, 'error');
            }
        }
        
        function showMessage(formId, message, type) {
            const messageDiv = document.querySelector(`#${formId} .error-message, #${formId} .success-message`);
            if (!messageDiv) return;
            
            messageDiv.innerHTML = message;
            messageDiv.className = type === 'error' ? 'error-message' : 'success-message';
        }
        
        // Funciones para ver detalles (a implementar)
        function viewPiloto(nuim) {
            const piloto = appData.pilotos.find(p => p.nuim === nuim);
            if (piloto) {
                alert(`Perfil de ${piloto.nombre}\nNUIM: ${piloto.nuim}\nRango: ${piloto.rango}\nEmail: ${piloto.correo}\nEstado: ${piloto.estado}`);
            }
        }
        
        function viewAeronave(callsign) {
            const aeronave = appData.aeronaves.find(a => a.callsign === callsign);
            if (aeronave) {
                alert(`Aeronave: ${aeronave.callsign}\nModelo: ${aeronave.modelo}\nCertificada: ${aeronave.certificada}`);
            }
        }
        
        function viewLibroVuelo(idLibro) {
            const libro = appData.librosVuelo.find(l => l.id_libro === idLibro);
            if (libro) {
                alert(`Libro de Vuelo: ${libro.id_libro}\nPiloto: ${libro.piloto}\nAeronave: ${libro.aeronave}\nTiempo: ${libro.tiempo_total} horas`);
            }
        }
        
        function viewSolicitud(idSolicitud) {
            const solicitud = appData.solicitudes.find(s => s.id_solicitud === idSolicitud);
            if (solicitud) {
                alert(`Solicitud: ${solicitud.id_solicitud}\nPiloto: ${solicitud.piloto}\nAeronave: ${solicitud.aeronave}\nEstado: ${solicitud.estado}`);
            }
        }
        
        function viewRango(nombreRango) {
            const rango = appData.rangos.find(r => r.nombre === nombreRango);
            if (rango) {
                alert(`Rango: ${rango.nombre}\nAbreviación: ${rango.abreviacion}\nEscalafón: ${rango.escalafon}`);
            }
        }
        
        // Hacer funciones globales para onclick
        window.viewPiloto = viewPiloto;
        window.viewAeronave = viewAeronave;
        window.viewLibroVuelo = viewLibroVuelo;
        window.viewSolicitud = viewSolicitud;
        window.viewRango = viewRango;
    </script>
</body>
</html>
