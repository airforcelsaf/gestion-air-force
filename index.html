<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fuerza Aérea - Sistema de Gestión</title>
    <style>
        :root {
            --primary: #1a4f85;
            --secondary: #8c2318;
            --accent: #5d8aa8;
            --light: #f4f4f4;
            --dark: #333;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
            color: #333;
            height: 100vh;
            overflow: hidden;
        }
        
        .view {
            display: none;
            padding: 20px;
            height: calc(100vh - 70px);
            overflow-y: auto;
        }
        
        .active {
            display: block;
        }
        
        /* Header y Navegación */
        header {
            background-color: var(--primary);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 70px;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
        }
        
        nav {
            display: flex;
            gap: 15px;
        }
        
        nav button {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 4px;
            font-weight: bold;
        }
        
        nav button:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        /* Contenido principal */
        #mainView {
            margin-top: 70px;
            height: calc(100vh - 70px);
        }
        
        /* Formularios */
        .form-container {
            max-width: 600px;
            margin: 20px auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        button {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
        
        button.secondary {
            background-color: var(--secondary);
        }
        
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        
        /* Listas y tarjetas */
        .card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        
        .card img {
            max-width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 4px;
            margin-bottom: 10px;
            background-color: #f0f0f0;
        }
        
        /* Login */
        #loginView {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
        }
        
        #loginView .form-container {
            max-width: 400px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        /* Perfil de piloto */
        .profile-header {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .profile-img {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            object-fit: cover;
            background-color: #f0f0f0;
        }
        
        .profile-info {
            flex: 1;
        }
        
        .embed-section {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        /* Tablas */
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        th {
            background-color: var(--primary);
            color: white;
        }
        
        tr:hover {
            background-color: #f5f5f5;
        }
        
        .error {
            color: red;
            margin-top: 10px;
            padding: 10px;
            background-color: #ffe6e6;
            border-radius: 4px;
            border: 1px solid #ffcccc;
        }
        
        .success {
            color: green;
            margin-top: 10px;
            padding: 10px;
            background-color: #e6ffe6;
            border-radius: 4px;
            border: 1px solid #ccffcc;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .debug-info {
            background-color: #f9f9f9;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            font-family: monospace;
            font-size: 12px;
            overflow: auto;
            max-height: 200px;
            display: none;
        }
        
        .placeholder-img {
            background-color: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #999;
            font-size: 14px;
        }
        
        h2 {
            margin-bottom: 20px;
            color: var(--primary);
        }
    </style>
</head>
<body>
    <!-- Vista de Login -->
    <div id="loginView" class="view active">
        <div class="form-container">
            <h2 style="text-align: center; margin-bottom: 20px;">Sistema de Gestión - Fuerza Aérea</h2>
            <form id="loginForm">
                <div class="form-group">
                    <label for="email">Correo electrónico</label>
                    <input type="email" id="email" required value="david_toro@lsaf.gov.us">
                </div>
                <div class="form-group">
                    <label for="password">Contraseña</label>
                    <input type="password" id="password" required value="12345">
                </div>
                <button type="submit" style="width: 100%;" id="loginButton">Iniciar Sesión</button>
                <div id="loginError" class="error" style="display: none;"></div>
            </form>
            <div style="margin-top: 20px; text-align: center;">
                <button onclick="toggleDebug()" style="background: #666; font-size: 12px;">Mostrar información de depuración</button>
                <div id="debugInfo" class="debug-info"></div>
            </div>
        </div>
    </div>

    <!-- Vista Principal (después del login) -->
    <div id="mainView" class="view">
        <header>
            <h1>Fuerza Aérea - Sistema de Gestión</h1>
            <nav>
                <button onclick="showView('pilotosView')">PILOTOS</button>
                <button onclick="showView('aeronavesView')">AERONAVES</button>
                <button onclick="showView('librosView')">LIBROS DE VUELO</button>
                <button onclick="showView('solicitudesView')">SOLICITUDES</button>
                <button onclick="showView('resumenView')">RESUMEN</button>
                <button onclick="showView('rangosView')">RANGOS</button>
                <button onclick="logout()">Cerrar Sesión</button>
            </nav>
        </header>

        <!-- Vista de Pilotos -->
        <div id="pilotosView" class="view">
            <h2>Gestión de Pilotos</h2>
            <button onclick="showAddPilotForm()">Agregar Piloto</button>
            <div class="card-grid" id="pilotosList">
                <p>Cargando pilotos...</p>
            </div>
        </div>

        <!-- Vista de Aeronaves -->
        <div id="aeronavesView" class="view">
            <h2>Gestión de Aeronaves</h2>
            <button onclick="showAddAircraftForm()">Agregar Aeronave</button>
            <div class="card-grid" id="aeronavesList">
                <p>Cargando aeronaves...</p>
            </div>
        </div>

        <!-- Vista de Libros de Vuelo -->
        <div id="librosView" class="view">
            <h2>Libros de Vuelo</h2>
            <button onclick="showAddFlightLogForm()">Agregar Libro de Vuelo</button>
            <div id="flightLogsList">
                <p>Cargando libros de vuelo...</p>
            </div>
        </div>

        <!-- Vista de Solicitudes -->
        <div id="solicitudesView" class="view">
            <h2>Solicitudes de Certificación</h2>
            <button onclick="showAddRequestForm()">Solicitar Certificación</button>
            <div id="requestsList">
                <p>Cargando solicitudes...</p>
            </div>
        </div>

        <!-- Vista de Resumen -->
        <div id="resumenView" class="view">
            <h2>Resumen de la Fuerza Aérea</h2>
            <div class="card-grid">
                <div id="leadershipInfo" class="card">
                    <h3>Liderazgo</h3>
                    <p>Cargando información de liderazgo...</p>
                </div>
                <div id="missionVision" class="card">
                    <h3>Misión y Visión</h3>
                    <p>Cargando misión y visión...</p>
                </div>
                <div id="flightTimesSummary" class="card">
                    <h3>Tiempos de Vuelo</h3>
                    <p>Cargando tiempos de vuelo...</p>
                </div>
            </div>
        </div>

        <!-- Vista de Rangos -->
        <div id="rangosView" class="view">
            <h2>Rangos de la Fuerza Aérea</h2>
            <button onclick="showAddRankForm()">Agregar Rango</button>
            <div class="card-grid" id="ranksList">
                <p>Cargando rangos...</p>
            </div>
        </div>
    </div>

    <!-- Formularios modales (ocultos inicialmente) -->
    <div id="modalOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
        <div id="modalContent" style="background: white; width: 90%; max-width: 600px; margin: 50px auto; padding: 20px; border-radius: 8px; max-height: 90vh; overflow-y: auto;">
            <!-- El contenido del modal se cargará dinámicamente -->
        </div>
    </div>

    <script>
        // URL de tu Google Apps Script
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyAr_UwJUUHfB7U9Qa-67DFi9DPW5MSAtptgIBUT0AesV2sFllH5pdXqGFaZE5NQreM1w/exec';
        
        // Datos del usuario actual
        let currentUser = null;
        let requestCounter = 0;
        let jsonpCallbacks = {};
        
        // Función para mostrar/ocultar información de depuración
        function toggleDebug() {
            const debugInfo = document.getElementById('debugInfo');
            debugInfo.style.display = debugInfo.style.display === 'none' ? 'block' : 'none';
        }
        
        // Función para agregar información de depuración
        function addDebugInfo(message) {
            const debugInfo = document.getElementById('debugInfo');
            const requestId = ++requestCounter;
            const timestamp = new Date().toLocaleTimeString();
            debugInfo.innerHTML += `[${timestamp}] #${requestId}: ${message}\n`;
            debugInfo.scrollTop = debugInfo.scrollHeight;
            return requestId;
        }
        
        // Función para realizar solicitudes usando JSONP (solución CORS)
        function makeRequest(data) {
            return new Promise((resolve, reject) => {
                const requestId = addDebugInfo(`Iniciando solicitud JSONP: ${JSON.stringify(data)}`);
                
                // Crear un ID único para el callback
                const callbackName = 'jsonp_callback_' + Math.round(100000 * Math.random());
                
                // Agregar el callback a los datos
                data.callback = callbackName;
                
                // Construir URL con parámetros
                const params = new URLSearchParams();
                for (const key in data) {
                    params.append(key, data[key]);
                }
                
                const url = `${SCRIPT_URL}?${params.toString()}`;
                addDebugInfo(`#${requestId}: URL: ${url}`);
                
                // Crear elemento script para JSONP
                const script = document.createElement('script');
                script.src = url;
                
                // Guardar la referencia al callback para limpiar después
                jsonpCallbacks[callbackName] = (response) => {
                    // Limpiar
                    delete jsonpCallbacks[callbackName];
                    document.body.removeChild(script);
                    
                    addDebugInfo(`#${requestId}: Respuesta recibida: ${JSON.stringify(response).substring(0, 200)}...`);
                    
                    // Resolver la promesa
                    resolve(response);
                };
                
                // Definir la función global de callback
                window[callbackName] = (response) => {
                    if (jsonpCallbacks[callbackName]) {
                        jsonpCallbacks[callbackName](response);
                    }
                };
                
                // Manejar errores
                script.onerror = () => {
                    delete jsonpCallbacks[callbackName];
                    document.body.removeChild(script);
                    addDebugInfo(`#${requestId}: Error en la solicitud JSONP`);
                    reject(new Error('Error de carga JSONP'));
                };
                
                // Agregar el script al documento
                document.body.appendChild(script);
            });
        }
        
        // Mostrar u ocultar vistas - VERSIÓN CORREGIDA
        function showView(viewId) {
            console.log("Intentando mostrar vista:", viewId);
            
            // Ocultar todas las vistas
            document.querySelectorAll('.view').forEach(view => {
                view.classList.remove('active');
            });
            
            // Mostrar la vista solicitada
            const targetView = document.getElementById(viewId);
            if (targetView) {
                targetView.classList.add('active');
                console.log("Vista mostrada correctamente:", viewId);
                
                // Si es una vista dentro de mainView, asegurarse de que mainView esté visible
                if (viewId !== 'loginView' && viewId !== 'mainView') {
                    document.getElementById('mainView').classList.add('active');
                }
            } else {
                console.error("No se encontró la vista:", viewId);
            }
        }
        
        // Cerrar sesión
        function logout() {
            currentUser = null;
            localStorage.removeItem('currentUser');
            showView('loginView');
        }
        
        // Mostrar modal con formulario
        function showModal(html) {
            document.getElementById('modalContent').innerHTML = html;
            document.getElementById('modalOverlay').style.display = 'block';
        }
        
        // Ocultar modal
        function hideModal() {
            document.getElementById('modalContent').innerHTML = '';
            document.getElementById('modalOverlay').style.display = 'none';
        }
        
        // Mostrar error de login
        function showLoginError(message) {
            const errorDiv = document.getElementById('loginError');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }
        
        // Ocultar error de login
        function hideLoginError() {
            const errorDiv = document.getElementById('loginError');
            errorDiv.style.display = 'none';
        }
        
        // Función para crear una imagen de placeholder
        function createPlaceholderImage(text, width = 150, height = 150) {
            // Crear un SVG como placeholder
            const svg = `
                <svg width="${width}" height="${height}" xmlns="http://www.w3.org/2000/svg">
                    <rect width="100%" height="100%" fill="#f0f0f0"/>
                    <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="#999" font-family="Arial" font-size="14">${text}</text>
                </svg>
            `;
            return 'data:image/svg+xml;base64,' + btoa(svg);
        }
        
        // Iniciar sesión
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const loginButton = document.getElementById('loginButton');
            
            // Cambiar texto del botón a "Cargando..."
            const originalText = loginButton.textContent;
            loginButton.innerHTML = '<span class="loading"></span> Cargando...';
            loginButton.disabled = true;
            hideLoginError();
            
            try {
                const result = await makeRequest({
                    action: 'login',
                    email: email,
                    password: password
                });
                
                if (result.success) {
                    currentUser = result.user;
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    
                    // Mostrar la vista principal y luego la de pilotos
                    showView('mainView');
                    showView('pilotosView');
                    
                    // Cargar datos en segundo plano
                    setTimeout(() => {
                        loadAllData();
                    }, 100);
                } else {
                    showLoginError('Error: ' + result.message);
                }
            } catch (error) {
                showLoginError('Error de conexión: ' + error.message);
            } finally {
                // Restaurar texto original del botón
                loginButton.textContent = originalText;
                loginButton.disabled = false;
            }
        });
        
        // Cargar todos los datos después del login
        async function loadAllData() {
            try {
                await loadPilots();
            } catch (error) {
                console.error('Error loading pilots:', error);
            }
            
            try {
                await loadAircrafts();
            } catch (error) {
                console.error('Error loading aircrafts:', error);
            }
            
            try {
                await loadFlightLogs();
            } catch (error) {
                console.error('Error loading flight logs:', error);
            }
            
            try {
                await loadRequests();
            } catch (error) {
                console.error('Error loading requests:', error);
            }
            
            try {
                await loadRanks();
            } catch (error) {
                console.error('Error loading ranks:', error);
            }
            
            try {
                await loadSummary();
            } catch (error) {
                console.error('Error loading summary:', error);
            }
        }
        
        // Cargar pilotos
        async function loadPilots() {
            try {
                const result = await makeRequest({
                    action: 'getPilots'
                });
                
                if (result.success) {
                    const pilotsList = document.getElementById('pilotosList');
                    pilotsList.innerHTML = '';
                    
                    if (result.data && result.data.length > 0) {
                        result.data.forEach(pilot => {
                            const pilotCard = document.createElement('div');
                            pilotCard.className = 'card';
                            const photoUrl = pilot.foto && pilot.foto.trim() !== '' ? 
                                pilot.foto : createPlaceholderImage('Sin foto');
                                
                            pilotCard.innerHTML = `
                                <h3>${pilot.nombre || 'Nombre no disponible'}</h3>
                                <img src="${photoUrl}" alt="Foto de ${pilot.nombre}" onerror="this.src='${createPlaceholderImage('Error al cargar')}'">
                                <p><strong>Rango:</strong> ${pilot.rango || 'No especificado'}</p>
                                <p><strong>NUIM:</strong> ${pilot.nuim || 'No especificado'}</p>
                                <button onclick="showPilotDetail('${pilot.correo}')">Ver Detalles</button>
                            `;
                            pilotsList.appendChild(pilotCard);
                        });
                    } else {
                        pilotsList.innerHTML = '<p>No hay pilotos registrados</p>';
                    }
                } else {
                    console.error('Error al cargar pilotos:', result.message);
                    document.getElementById('pilotosList').innerHTML = '<p>Error al cargar los pilotos: ' + result.message + '</p>';
                }
            } catch (error) {
                console.error('Error loading pilots:', error);
                document.getElementById('pilotosList').innerHTML = '<p>Error al cargar los pilotos: ' + error.message + '</p>';
            }
        }
        
        // Cargar aeronaves
        async function loadAircrafts() {
            try {
                const result = await makeRequest({
                    action: 'getAircrafts'
                });
                
                if (result.success) {
                    const aircraftsList = document.getElementById('aeronavesList');
                    aircraftsList.innerHTML = '';
                    
                    if (result.data && result.data.length > 0) {
                        result.data.forEach(aircraft => {
                            const aircraftCard = document.createElement('div');
                            aircraftCard.className = 'card';
                            const photoUrl = aircraft.foto && aircraft.foto.trim() !== '' ? 
                                aircraft.foto : createPlaceholderImage('Sin foto');
                                
                            aircraftCard.innerHTML = `
                                <h3>${aircraft.callsign || 'Callsign no disponible'}</h3>
                                <p><strong>Modelo:</strong> ${aircraft.modelo || 'No especificado'}</p>
                                <img src="${photoUrl}" alt="Foto de ${aircraft.callsign}" onerror="this.src='${createPlaceholderImage('Error al cargar')}'">
                            `;
                            aircraftsList.appendChild(aircraftCard);
                        });
                    } else {
                        aircraftsList.innerHTML = '<p>No hay aeronaves registradas</p>';
                    }
                } else {
                    console.error('Error al cargar aeronaves:', result.message);
                    document.getElementById('aeronavesList').innerHTML = '<p>Error al cargar las aeronaves: ' + result.message + '</p>';
                }
            } catch (error) {
                console.error('Error loading aircrafts:', error);
                document.getElementById('aeronavesList').innerHTML = '<p>Error al cargar las aeronaves: ' + error.message + '</p>';
            }
        }
        
        // Cargar libros de vuelo
        async function loadFlightLogs() {
            try {
                const result = await makeRequest({
                    action: 'getFlightLogs'
                });
                
                if (result.success) {
                    const flightLogsList = document.getElementById('flightLogsList');
                    flightLogsList.innerHTML = '';
                    
                    if (result.data && result.data.length > 0) {
                        const table = document.createElement('table');
                        table.innerHTML = `
                            <thead>
                                <tr>
                                    <th>Libro</th>
                                    <th>Piloto</th>
                                    <th>Aeronave</th>
                                    <th>Hora Despegue</th>
                                    <th>Hora Aterrizaje</th>
                                    <th>Tiempo Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${result.data.map(log => `
                                    <tr>
                                        <td>${log.libro || 'N/A'}</td>
                                        <td>${log.piloto || 'N/A'}</td>
                                        <td>${log.aeronave || 'N/A'}</td>
                                        <td>${log.hora_despegue || 'N/A'}</td>
                                        <td>${log.hora_aterrizaje || 'N/A'}</td>
                                        <td>${log.tiempo_total || 'N/A'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        `;
                        flightLogsList.appendChild(table);
                    } else {
                        flightLogsList.innerHTML = '<p>No hay libros de vuelo registrados</p>';
                    }
                } else {
                    console.error('Error al cargar libros de vuelo:', result.message);
                    document.getElementById('flightLogsList').innerHTML = '<p>Error al cargar los libros de vuelo: ' + result.message + '</p>';
                }
            } catch (error) {
                console.error('Error loading flight logs:', error);
                document.getElementById('flightLogsList').innerHTML = '<p>Error al cargar los libros de vuelo: ' + error.message + '</p>';
            }
        }
        
        // Cargar solicitudes
        async function loadRequests() {
            try {
                const result = await makeRequest({
                    action: 'getRequests'
                });
                
                if (result.success) {
                    const requestsList = document.getElementById('requestsList');
                    requestsList.innerHTML = '';
                    
                    if (result.data && result.data.length > 0) {
                        const table = document.createElement('table');
                        table.innerHTML = `
                            <thead>
                                <tr>
                                    <th>Solicitud</th>
                                    <th>Piloto</th>
                                    <th>Aeronave</th>
                                    <th>Fecha</th>
                                    <th>Disponibilidad</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${result.data.map(req => `
                                    <tr>
                                        <td>${req.solicitud || 'N/A'}</td>
                                        <td>${req.piloto || 'N/A'}</td>
                                        <td>${req.aeronave || 'N/A'}</td>
                                        <td>${req.fecha || 'N/A'}</td>
                                        <td>${req.disponibilidad || 'N/A'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        `;
                        requestsList.appendChild(table);
                    } else {
                        requestsList.innerHTML = '<p>No hay solicitudes registradas</p>';
                    }
                } else {
                    console.error('Error al cargar solicitudes:', result.message);
                    document.getElementById('requestsList').innerHTML = '<p>Error al cargar las solicitudes: ' + result.message + '</p>';
                }
            } catch (error) {
                console.error('Error loading requests:', error);
                document.getElementById('requestsList').innerHTML = '<p>Error al cargar las solicitudes: ' + error.message + '</p>';
            }
        }
        
        // Cargar rangos
        async function loadRanks() {
            try {
                const result = await makeRequest({
                    action: 'getRanks'
                });
                
                if (result.success) {
                    const ranksList = document.getElementById('ranksList');
                    ranksList.innerHTML = '';
                    
                    if (result.data && result.data.length > 0) {
                        result.data.forEach(rank => {
                            const rankCard = document.createElement('div');
                            rankCard.className = 'card';
                            const photoUrl = rank.foto && rank.foto.trim() !== '' ? 
                                rank.foto : createPlaceholderImage('Sin insignia');
                                
                            rankCard.innerHTML = `
                                <h3>${rank.nombre || 'Nombre no disponible'}</h3>
                                <p><strong>Abreviación:</strong> ${rank.abreviacion || 'No especificada'}</p>
                                <p><strong>Escalafón:</strong> ${rank.escalafon || 'No especificado'}</p>
                                <img src="${photoUrl}" alt="Insignia de ${rank.nombre}" onerror="this.src='${createPlaceholderImage('Error al cargar')}'">
                            `;
                            ranksList.appendChild(rankCard);
                        });
                    } else {
                        ranksList.innerHTML = '<p>No hay rangos registrados</p>';
                    }
                } else {
                    console.error('Error al cargar rangos:', result.message);
                    document.getElementById('ranksList').innerHTML = '<p>Error al cargar los rangos: ' + result.message + '</p>';
                }
            } catch (error) {
                console.error('Error loading ranks:', error);
                document.getElementById('ranksList').innerHTML = '<p>Error al cargar los rangos: ' + error.message + '</p>';
            }
        }
        
        // Cargar resumen
        async function loadSummary() {
            try {
                const result = await makeRequest({
                    action: 'getSummary'
                });
                
                if (result.success) {
                    const leadershipInfo = document.getElementById('leadershipInfo');
                    const missionVision = document.getElementById('missionVision');
                    const flightTimesSummary = document.getElementById('flightTimesSummary');
                    
                    // Verificar si result.data existe y tiene la estructura esperada
                    if (!result.data) {
                        console.error('Datos de resumen no disponibles');
                        return;
                    }
                    
                    const leader = result.data.lider || {};
                    const mission = result.data.mision || 'No especificada';
                    const vision = result.data.vision || 'No especificada';
                    const totalTime = result.data.tiempos_totales || '0';
                    
                    const leaderPhoto = leader.foto && leader.foto.trim() !== '' ? 
                        leader.foto : createPlaceholderImage('Sin foto');
                    
                    if (leadershipInfo) {
                        leadershipInfo.innerHTML = `
                            <h3>Liderazgo</h3>
                            <p><strong>Líder:</strong> ${leader.nombre || 'No especificado'}</p>
                            <p><strong>Fecha de asunción:</strong> ${leader.fecha_asuncion || 'No especificada'}</p>
                            <img src="${leaderPhoto}" alt="Foto del líder" onerror="this.src='${createPlaceholderImage('Error al cargar')}'" style="height: 100px; object-fit: cover;">
                        `;
                    }
                    
                    if (missionVision) {
                        missionVision.innerHTML = `
                            <h3>Misión y Visión</h3>
                            <p><strong>Misión:</strong> ${mission}</p>
                            <p><strong>Visión:</strong> ${vision}</p>
                        `;
                    }
                    
                    if (flightTimesSummary) {
                        flightTimesSummary.innerHTML = `
                            <h3>Tiempos de Vuelo Totales</h3>
                            <p>Total de horas voladas: ${totalTime} horas</p>
                        `;
                    }
                } else {
                    console.error('Error al cargar resumen:', result.message);
                }
            } catch (error) {
                console.error('Error loading summary:', error);
            }
        }

        // Las demás funciones (showAddPilotForm, addPilot, showPilotDetail, etc.) se mantienen igual
        // ... (código existente para los formularios modales)

        // Inicialización
        document.addEventListener('DOMContentLoaded', function() {
            // Verificar si ya hay una sesión activa
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                showView('mainView');
                showView('pilotosView'); // Mostrar pilotos por defecto
                setTimeout(() => {
                    loadAllData();
                }, 100);
            }
            
            // Agregar evento para cerrar modal al hacer clic fuera
            document.getElementById('modalOverlay').addEventListener('click', function(e) {
                if (e.target === this) {
                    hideModal();
                }
            });
        });
    </script>
</body>
</html>
