<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fuerza Aérea - Sistema de Gestión</title>
    <style>
        :root {
            --primary: #1a4f85;
            --secondary: #8c2318;
            --accent: #5d8aa8;
            --light: #f4f4f4;
            --dark: #333;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
            color: #333;
        }
        
        .view {
            display: none;
            padding: 20px;
        }
        
        .active {
            display: block;
        }
        
        /* Header y Navegación */
        header {
            background-color: var(--primary);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        nav {
            display: flex;
            gap: 15px;
        }
        
        nav button {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 4px;
            font-weight: bold;
        }
        
        nav button:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        /* Formularios */
        .form-container {
            max-width: 600px;
            margin: 20px auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        button {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
        
        button.secondary {
            background-color: var(--secondary);
        }
        
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        
        /* Listas y tarjetas */
        .card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        .card img {
            max-width: 100%;
            height: auto;
            border-radius: 4px;
        }
        
        /* Login */
        #loginView {
            max-width: 400px;
            margin: 50px auto;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        /* Perfil de piloto */
        .profile-header {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .profile-img {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            object-fit: cover;
        }
        
        .profile-info {
            flex: 1;
        }
        
        .embed-section {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        /* Tablas */
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        th {
            background-color: var(--primary);
            color: white;
        }
        
        tr:hover {
            background-color: #f5f5f5;
        }
        
        .error {
            color: red;
            margin-top: 10px;
            padding: 10px;
            background-color: #ffe6e6;
            border-radius: 4px;
            border: 1px solid #ffcccc;
        }
        
        .success {
            color: green;
            margin-top: 10px;
            padding: 10px;
            background-color: #e6ffe6;
            border-radius: 4px;
            border: 1px solid #ccffcc;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .debug-info {
            background-color: #f9f9f9;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            font-family: monospace;
            font-size: 12px;
            overflow: auto;
            max-height: 200px;
            display: none;
        }
    </style>
</head>
<body>
    <!-- Vista de Login -->
    <div id="loginView" class="view active">
        <h2 style="text-align: center; margin-bottom: 20px;">Sistema de Gestión - Fuerza Aérea</h2>
        <form id="loginForm">
            <div class="form-group">
                <label for="email">Correo electrónico</label>
                <input type="email" id="email" required value="david_toro@lsaf.gov.us">
            </div>
            <div class="form-group">
                <label for="password">Contraseña</label>
                <input type="password" id="password" required value="12345">
            </div>
            <button type="submit" style="width: 100%;" id="loginButton">Iniciar Sesión</button>
            <div id="loginError" class="error" style="display: none;"></div>
        </form>
        <div style="margin-top: 20px; text-align: center;">
            <button onclick="toggleDebug()" style="background: #666; font-size: 12px;">Mostrar información de depuración</button>
            <div id="debugInfo" class="debug-info"></div>
        </div>
    </div>

    <!-- Vista Principal (después del login) -->
    <div id="mainView" class="view">
        <header>
            <h1>Fuerza Aérea - Sistema de Gestión</h1>
            <nav>
                <button onclick="showView('pilotosView')">PILOTOS</button>
                <button onclick="showView('aeronavesView')">AERONAVES</button>
                <button onclick="showView('librosView')">LIBROS DE VUELO</button>
                <button onclick="showView('solicitudesView')">SOLICITUDES</button>
                <button onclick="showView('resumenView')">RESUMEN</button>
                <button onclick="showView('rangosView')">RANGOS</button>
                <button onclick="logout()">Cerrar Sesión</button>
            </nav>
        </header>

        <!-- Vista de Pilotos -->
        <div id="pilotosView" class="view">
            <h2>Gestión de Pilotos</h2>
            <button onclick="showAddPilotForm()">Agregar Piloto</button>
            <div class="card-grid" id="pilotosList">
                <!-- Los pilotos se cargarán aquí dinámicamente -->
            </div>
        </div>

        <!-- Vista de Aeronaves -->
        <div id="aeronavesView" class="view">
            <h2>Gestión de Aeronaves</h2>
            <button onclick="showAddAircraftForm()">Agregar Aeronave</button>
            <div class="card-grid" id="aeronavesList">
                <!-- Las aeronaves se cargarán aquí dinámicamente -->
            </div>
        </div>

        <!-- Vista de Libros de Vuelo -->
        <div id="librosView" class="view">
            <h2>Libros de Vuelo</h2>
            <button onclick="showAddFlightLogForm()">Agregar Libro de Vuelo</button>
            <div id="flightLogsList">
                <!-- Los libros de vuelo se cargarán aquí dinámicamente -->
            </div>
        </div>

        <!-- Vista de Solicitudes -->
        <div id="solicitudesView" class="view">
            <h2>Solicitudes de Certificación</h2>
            <button onclick="showAddRequestForm()">Solicitar Certificación</button>
            <div id="requestsList">
                <!-- Las solicitudes se cargarán aquí dinámicamente -->
            </div>
        </div>

        <!-- Vista de Resumen -->
        <div id="resumenView" class="view">
            <h2>Resumen de la Fuerza Aérea</h2>
            <div id="leadershipInfo">
                <!-- Información de liderazgo -->
            </div>
            <div id="missionVision">
                <!-- Misión y visión -->
            </div>
            <div id="flightTimesSummary">
                <!-- Resumen de tiempos de vuelo -->
            </div>
        </div>

        <!-- Vista de Rangos -->
        <div id="rangosView" class="view">
            <h2>Rangos de la Fuerza Aérea</h2>
            <button onclick="showAddRankForm()">Agregar Rango</button>
            <div class="card-grid" id="ranksList">
                <!-- Los rangos se cargarán aquí dinámicamente -->
            </div>
        </div>
    </div>

    <!-- Formularios modales (ocultos inicialmente) -->
    <div id="modalOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
        <div id="modalContent" style="background: white; width: 90%; max-width: 600px; margin: 50px auto; padding: 20px; border-radius: 8px; max-height: 90vh; overflow-y: auto;">
            <!-- El contenido del modal se cargará dinámicamente -->
        </div>
    </div>

    <script>
        // URL de tu Google Apps Script
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzDAjJx-5rvl2glJ65_J251-7OD-vxsj9xEaCk42c-1285j7TdFDfUPnXHCd8lZmwjxxw/exec';
        
        // Datos del usuario actual
        let currentUser = null;
        let requestCounter = 0;
        
        // Función para mostrar/ocultar información de depuración
        function toggleDebug() {
            const debugInfo = document.getElementById('debugInfo');
            debugInfo.style.display = debugInfo.style.display === 'none' ? 'block' : 'none';
        }
        
        // Función para agregar información de depuración
        function addDebugInfo(message) {
            const debugInfo = document.getElementById('debugInfo');
            const requestId = ++requestCounter;
            const timestamp = new Date().toLocaleTimeString();
            debugInfo.innerHTML += `[${timestamp}] #${requestId}: ${message}\n`;
            debugInfo.scrollTop = debugInfo.scrollHeight;
            return requestId;
        }
        
        // Función para realizar solicitudes con manejo de CORS
        async function makeRequest(data) {
            const requestId = addDebugInfo(`Iniciando solicitud: ${JSON.stringify(data)}`);
            
            try {
                // Usar enfoque JSONP para evitar problemas de CORS
                return await new Promise((resolve, reject) => {
                    const callbackName = 'jsonp_callback_' + Date.now() + '_' + Math.round(1000000 * Math.random());
                    const script = document.createElement('script');
                    
                    // Construir URL con parámetros
                    const params = new URLSearchParams();
                    for (const key in data) {
                        params.append(key, data[key]);
                    }
                    
                    // Configurar el script
                    window[callbackName] = function(response) {
                        delete window[callbackName];
                        document.body.removeChild(script);
                        
                        if (response.success) {
                            addDebugInfo(`#${requestId}: Respuesta exitosa`);
                            resolve(response);
                        } else {
                            addDebugInfo(`#${requestId}: Error en respuesta: ${response.message}`);
                            reject(new Error(response.message || 'Error desconocido'));
                        }
                    };
                    
                    // Manejar errores
                    script.onerror = function() {
                        delete window[callbackName];
                        document.body.removeChild(script);
                        addDebugInfo(`#${requestId}: Error de carga del script`);
                        reject(new Error('Error de conexión con el servidor'));
                    };
                    
                    // Establecer la fuente del script
                    script.src = `${SCRIPT_URL}?${params.toString()}&callback=${callbackName}`;
                    document.body.appendChild(script);
                    
                    // Timeout después de 30 segundos
                    setTimeout(() => {
                        if (window[callbackName]) {
                            delete window[callbackName];
                            document.body.removeChild(script);
                            addDebugInfo(`#${requestId}: Timeout de la solicitud`);
                            reject(new Error('Timeout de la solicitud'));
                        }
                    }, 30000);
                });
            } catch (error) {
                addDebugInfo(`#${requestId}: Error en la solicitud: ${error.message}`);
                
                // Intentar con fetch como fallback
                try {
                    addDebugInfo(`#${requestId}: Intentando con fetch como fallback`);
                    
                    // Usar proxy CORS para evitar problemas
                    const proxyUrl = 'https://api.allorigins.win/raw?url=' + encodeURIComponent(SCRIPT_URL);
                    const response = await fetch(proxyUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: new URLSearchParams(data).toString()
                    });
                    
                    const text = await response.text();
                    addDebugInfo(`#${requestId}: Respuesta en texto: ${text.substring(0, 200)}...`);
                    
                    // Intentar parsear como JSON
                    try {
                        const result = JSON.parse(text);
                        if (result.success) {
                            addDebugInfo(`#${requestId}: Respuesta exitosa con fetch`);
                            return result;
                        } else {
                            throw new Error(result.message || 'Error desconocido');
                        }
                    } catch (e) {
                        // Si falla el parseo JSON, verificar si es HTML
                        if (text.includes('<!DOCTYPE') || text.includes('<html')) {
                            addDebugInfo(`#${requestId}: El servidor respondió con HTML en lugar de JSON`);
                            throw new Error('El servidor respondió con una página HTML. Verifica la URL del script.');
                        } else {
                            addDebugInfo(`#${requestId}: No se pudo parsear la respuesta: ${text.substring(0, 100)}`);
                            throw new Error('Respuesta inválida del servidor');
                        }
                    }
                } catch (secondError) {
                    addDebugInfo(`#${requestId}: Error en segundo intento: ${secondError.message}`);
                    throw new Error('No se pudo conectar con el servidor: ' + secondError.message);
                }
            }
        }
        
        // Mostrar u ocultar vistas
        function showView(viewId) {
            document.querySelectorAll('.view').forEach(view => {
                view.classList.remove('active');
            });
            document.getElementById(viewId).classList.add('active');
        }
        
        // Cerrar sesión
        function logout() {
            currentUser = null;
            localStorage.removeItem('currentUser');
            showView('loginView');
        }
        
        // Mostrar modal con formulario
        function showModal(html) {
            document.getElementById('modalContent').innerHTML = html;
            document.getElementById('modalOverlay').style.display = 'block';
        }
        
        // Ocultar modal
        function hideModal() {
            document.getElementById('modalContent').innerHTML = '';
            document.getElementById('modalOverlay').style.display = 'none';
        }
        
        // Mostrar error de login
        function showLoginError(message) {
            const errorDiv = document.getElementById('loginError');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }
        
        // Ocultar error de login
        function hideLoginError() {
            const errorDiv = document.getElementById('loginError');
            errorDiv.style.display = 'none';
        }
        
        // Iniciar sesión
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const loginButton = document.getElementById('loginButton');
            
            // Cambiar texto del botón a "Cargando..."
            const originalText = loginButton.textContent;
            loginButton.innerHTML = '<span class="loading"></span> Cargando...';
            loginButton.disabled = true;
            hideLoginError();
            
            try {
                const result = await makeRequest({
                    action: 'login',
                    email: email,
                    password: password
                });
                
                if (result.success) {
                    currentUser = result.user;
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    showView('mainView');
                    await loadAllData();
                } else {
                    showLoginError('Error: ' + result.message);
                }
            } catch (error) {
                showLoginError('Error de conexión: ' + error.message);
            } finally {
                // Restaurar texto original del botón
                loginButton.textContent = originalText;
                loginButton.disabled = false;
            }
        });
        
        // Cargar todos los datos después del login
        async function loadAllData() {
            await loadPilots();
            await loadAircrafts();
            await loadFlightLogs();
            await loadRequests();
            await loadRanks();
            await loadSummary();
        }
        
        // Cargar pilotos
        async function loadPilots() {
            try {
                const result = await makeRequest({
                    action: 'getPilots'
                });
                
                if (result.success) {
                    const pilotsList = document.getElementById('pilotosList');
                    pilotsList.innerHTML = '';
                    
                    if (result.data && result.data.length > 0) {
                        result.data.forEach(pilot => {
                            const pilotCard = document.createElement('div');
                            pilotCard.className = 'card';
                            pilotCard.innerHTML = `
                                <h3>${pilot.nombre}</h3>
                                <img src="${pilot.foto || 'https://via.placeholder.com/150'}" alt="Foto de ${pilot.nombre}" style="height: 100px; object-fit: cover;">
                                <p>Rango: ${pilot.rango}</p>
                                <button onclick="showPilotDetail('${pilot.correo}')">Ver Detalles</button>
                            `;
                            pilotsList.appendChild(pilotCard);
                        });
                    } else {
                        pilotsList.innerHTML = '<p>No hay pilotos registrados</p>';
                    }
                } else {
                    console.error('Error al cargar pilotos:', result.message);
                }
            } catch (error) {
                console.error('Error loading pilots:', error);
            }
        }
        
        // Cargar aeronaves
        async function loadAircrafts() {
            try {
                const result = await makeRequest({
                    action: 'getAircrafts'
                });
                
                if (result.success) {
                    const aircraftsList = document.getElementById('aeronavesList');
                    aircraftsList.innerHTML = '';
                    
                    if (result.data && result.data.length > 0) {
                        result.data.forEach(aircraft => {
                            const aircraftCard = document.createElement('div');
                            aircraftCard.className = 'card';
                            aircraftCard.innerHTML = `
                                <h3>${aircraft.callsign}</h3>
                                <p>Modelo: ${aircraft.modelo}</p>
                                <img src="${aircraft.foto || 'https://via.placeholder.com/150'}" alt="Foto de ${aircraft.callsign}" style="height: 100px; object-fit: cover;">
                            `;
                            aircraftsList.appendChild(aircraftCard);
                        });
                    } else {
                        aircraftsList.innerHTML = '<p>No hay aeronaves registradas</p>';
                    }
                }
            } catch (error) {
                console.error('Error loading aircrafts:', error);
            }
        }
        
        // Cargar libros de vuelo
        async function loadFlightLogs() {
            try {
                const result = await makeRequest({
                    action: 'getFlightLogs'
                });
                
                if (result.success) {
                    const flightLogsList = document.getElementById('flightLogsList');
                    flightLogsList.innerHTML = '';
                    
                    if (result.data && result.data.length > 0) {
                        const table = document.createElement('table');
                        table.innerHTML = `
                            <thead>
                                <tr>
                                    <th>Libro</th>
                                    <th>Piloto</th>
                                    <th>Aeronave</th>
                                    <th>Hora Despegue</th>
                                    <th>Hora Aterrizaje</th>
                                    <th>Tiempo Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${result.data.map(log => `
                                    <tr>
                                        <td>${log.libro}</td>
                                        <td>${log.piloto}</td>
                                        <td>${log.aeronave}</td>
                                        <td>${log.hora_despegue}</td>
                                        <td>${log.hora_aterrizaje}</td>
                                        <td>${log.tiempo_total}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        `;
                        flightLogsList.appendChild(table);
                    } else {
                        flightLogsList.innerHTML = '<p>No hay libros de vuelo registrados</p>';
                    }
                }
            } catch (error) {
                console.error('Error loading flight logs:', error);
            }
        }
        
        // Cargar solicitudes
        async function loadRequests() {
            try {
                const result = await makeRequest({
                    action: 'getRequests'
                });
                
                if (result.success) {
                    const requestsList = document.getElementById('requestsList');
                    requestsList.innerHTML = '';
                    
                    if (result.data && result.data.length > 0) {
                        const table = document.createElement('table');
                        table.innerHTML = `
                            <thead>
                                <tr>
                                    <th>Solicitud</th>
                                    <th>Piloto</th>
                                    <th>Aeronave</th>
                                    <th>Fecha</th>
                                    <th>Disponibilidad</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${result.data.map(req => `
                                    <tr>
                                        <td>${req.solicitud}</td>
                                        <td>${req.piloto}</td>
                                        <td>${req.aeronave}</td>
                                        <td>${req.fecha}</td>
                                        <td>${req.disponibilidad}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        `;
                        requestsList.appendChild(table);
                    } else {
                        requestsList.innerHTML = '<p>No hay solicitudes registradas</p>';
                    }
                }
            } catch (error) {
                console.error('Error loading requests:', error);
            }
        }
        
        // Cargar rangos
        async function loadRanks() {
            try {
                const result = await makeRequest({
                    action: 'getRanks'
                });
                
                if (result.success) {
                    const ranksList = document.getElementById('ranksList');
                    ranksList.innerHTML = '';
                    
                    if (result.data && result.data.length > 0) {
                        result.data.forEach(rank => {
                            const rankCard = document.createElement('div');
                            rankCard.className = 'card';
                            rankCard.innerHTML = `
                                <h3>${rank.nombre}</h3>
                                <p>Abreviación: ${rank.abreviacion}</p>
                                <p>Escalafón: ${rank.escalafon}</p>
                                <img src="${rank.foto || 'https://via.placeholder.com/150'}" alt="Insignia de ${rank.nombre}" style="height: 100px; object-fit: cover;">
                            `;
                            ranksList.appendChild(rankCard);
                        });
                    } else {
                        ranksList.innerHTML = '<p>No hay rangos registrados</p>';
                    }
                }
            } catch (error) {
                console.error('Error loading ranks:', error);
            }
        }
        
        // Cargar resumen
        async function loadSummary() {
            try {
                const result = await makeRequest({
                    action: 'getSummary'
                });
                
                if (result.success) {
                    const leadershipInfo = document.getElementById('leadershipInfo');
                    const missionVision = document.getElementById('missionVision');
                    const flightTimesSummary = document.getElementById('flightTimesSummary');
                    
                    leadershipInfo.innerHTML = `
                        <div class="card">
                            <h3>Liderazgo</h3>
                            <p>Líder: ${result.data.lider?.nombre || 'No especificado'}</p>
                            <p>Fecha de asunción: ${result.data.lider?.fecha_asuncion || 'No especificada'}</p>
                            <img src="${result.data.lider?.foto || 'https://via.placeholder.com/150'}" alt="Foto del líder" style="height: 100px; object-fit: cover;">
                        </div>
                    `;
                    
                    missionVision.innerHTML = `
                        <div class="card">
                            <h3>Misión y Visión</h3>
                            <p><strong>Misión:</strong> ${result.data.mision || 'No especificada'}</p>
                            <p><strong>Visión:</strong> ${result.data.vision || 'No especificada'}</p>
                        </div>
                    `;
                    
                    flightTimesSummary.innerHTML = `
                        <div class="card">
                            <h3>Tiempos de Vuelo Totales</h3>
                            <p>Total de horas voladas: ${result.data.tiempos_totales || '0'} horas</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading summary:', error);
            }
        }

        // Mostrar formulario para agregar piloto
        function showAddPilotForm() {
            const formHtml = `
                <h2>Agregar Nuevo Piloto</h2>
                <form onsubmit="event.preventDefault(); addPilot()">
                    <div class="form-group">
                        <label for="newPilotEmail">Correo electrónico</label>
                        <input type="email" id="newPilotEmail" required>
                    </div>
                    <div class="form-group">
                        <label for="newPilotPassword">Contraseña</label>
                        <input type="password" id="newPilotPassword" required>
                    </div>
                    <div class="form-group">
                        <label for="newPilotName">Nombre completo</label>
                        <input type="text" id="newPilotName" required>
                    </div>
                    <div class="form-group">
                        <label for="newPilotRank">Rango</label>
                        <input type="text" id="newPilotRank" required>
                    </div>
                    <div class="form-group">
                        <label for="newPilotNUIM">NUIM</label>
                        <input type="text" id="newPilotNUIM" required>
                    </div>
                    <div class="form-group">
                        <label for="newPilotBirthdate">Fecha de nacimiento</label>
                        <input type="date" id="newPilotBirthdate" required>
                    </div>
                    <div class="form-group">
                        <label for="newPilotPhone">Teléfono</label>
                        <input type="tel" id="newPilotPhone" required>
                    </div>
                    <div class="form-group">
                        <label for="newPilotBloodType">Tipo de sangre</label>
                        <input type="text" id="newPilotBloodType" required>
                    </div>
                    <div class="form-group">
                        <label for="newPilotPhoto">URL de la foto</label>
                        <input type="url" id="newPilotPhoto">
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button type="submit">Agregar</button>
                        <button type="button" onclick="hideModal()">Cancelar</button>
                    </div>
                </form>
            `;
            
            showModal(formHtml);
        }
        
        // Agregar piloto
        async function addPilot() {
            alert('Función de agregar piloto en desarrollo');
        }
        
        // Mostrar detalles del piloto
        async function showPilotDetail(email) {
            try {
                const result = await makeRequest({
                    action: 'getPilotDetail',
                    email: email
                });
                
                if (result.success) {
                    const pilot = result.data;
                    let detailHtml = `
                        <h2>Perfil de ${pilot.nombre}</h2>
                        <div class="profile-header">
                            <img src="${pilot.foto || 'https://via.placeholder.com/150'}" alt="Foto de ${pilot.nombre}" class="profile-img">
                            <div class="profile-info">
                                <p><strong>Rango:</strong> ${pilot.rango}</p>
                                <p><strong>NUIM:</strong> ${pilot.nuim}</p>
                                <p><strong>Fecha de nacimiento:</strong> ${pilot.fecha_nacimiento}</p>
                                <p><strong>Teléfono:</strong> ${pilot.telefono}</p>
                                <p><strong>Tipo de sangre:</strong> ${pilot.tipo_sangre}</p>
                            </div>
                        </div>
                    `;
                    
                    // Certificaciones
                    detailHtml += `
                        <div class="embed-section">
                            <h3>Certificaciones</h3>
                            <ul id="certificationsList">
                                ${pilot.certificaciones && pilot.certificaciones.length > 0 ? 
                                    pilot.certificaciones.map(cert => `<li>${cert.aeronave} - ${cert.fecha}</li>`).join('') : 
                                    '<li>No tiene certificaciones</li>'}
                            </ul>
                            <button onclick="alert('Función en desarrollo')">Agregar Certificación</button>
                        </div>
                    `;
                    
                    // Libros de vuelo
                    detailHtml += `
                        <div class="embed-section">
                            <h3>Libros de Vuelo</h3>
                            <table>
                                <thead>
                                    <tr>
                                        <th>Aeronave</th>
                                        <th>Fecha</th>
                                        <th>Tiempo Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${pilot.libros_vuelo && pilot.libros_vuelo.length > 0 ? 
                                        pilot.libros_vuelo.map(book => `
                                            <tr>
                                                <td>${book.aeronave}</td>
                                                <td>${book.fecha}</td>
                                                <td>${book.tiempo_total}</td>
                                            </tr>
                                        `).join('') : 
                                        '<tr><td colspan="3">No tiene libros de vuelo</td></tr>'}
                                </tbody>
                            </table>
                        </div>
                    `;
                    
                    // Solicitudes
                    detailHtml += `
                        <div class="embed-section">
                            <h3>Solicitudes de Certificación</h3>
                            <ul>
                                ${pilot.solicitudes && pilot.solicitudes.length > 0 ? 
                                    pilot.solicitudes.map(req => `<li>${req.aeronave} - ${req.estado}</li>`).join('') : 
                                    '<li>No tiene solicitudes pendientes</li>'}
                            </ul>
                        </div>
                    `;
                    
                    // Botón de editar
                    detailHtml += `
                        <button onclick="alert('Función en desarrollo')">Editar Piloto</button>
                    `;
                    
                    showModal(detailHtml);
                }
            } catch (error) {
                console.error('Error loading pilot details:', error);
                alert('Error al cargar los detalles del piloto: ' + error.message);
            }
        }
        
        // Mostrar formulario para agregar aeronave
        function showAddAircraftForm() {
            const formHtml = `
                <h2>Agregar Nueva Aeronave</h2>
                <form onsubmit="event.preventDefault(); addAircraft()">
                    <div class="form-group">
                        <label for="newAircraftCallsign">Callsign</label>
                        <input type="text" id="newAircraftCallsign" required>
                    </div>
                    <div class="form-group">
                        <label for="newAircraftModel">Modelo</label>
                        <input type="text" id="newAircraftModel" required>
                    </div>
                    <div class="form-group">
                        <label for="newAircraftPhoto">URL de la foto</label>
                        <input type="url" id="newAircraftPhoto">
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button type="submit">Agregar</button>
                        <button type="button" onclick="hideModal()">Cancelar</button>
                    </div>
                </form>
            `;
            
            showModal(formHtml);
        }
        
        // Agregar aeronave
        async function addAircraft() {
            alert('Función de agregar aeronave en desarrollo');
        }
        
        // Mostrar formulario para agregar libro de vuelo
        function showAddFlightLogForm() {
            const formHtml = `
                <h2>Agregar Libro de Vuelo</h2>
                <form onsubmit="event.preventDefault(); addFlightLog()">
                    <div class="form-group">
                        <label for="newFlightLogAircraft">Aeronave</label>
                        <select id="newFlightLogAircraft" required>
                            <option value="">Seleccionar aeronave</option>
                            <!-- Las opciones se cargarán dinámicamente -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="newFlightLogTakeoff">Hora de Despegue</label>
                        <input type="datetime-local" id="newFlightLogTakeoff" required>
                    </div>
                    <div class="form-group">
                        <label for="newFlightLogLanding">Hora de Aterrizaje</label>
                        <input type="datetime-local" id="newFlightLogLanding" required>
                    </div>
                    <div class="form-group">
                        <label for="newFlightLogRoute">Ruta</label>
                        <input type="text" id="newFlightLogRoute" required>
                    </div>
                    <div class="form-group">
                        <label for="newFlightLogReason">Motivo</label>
                        <textarea id="newFlightLogReason" required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="newFlightLogObservations">Observaciones</label>
                        <textarea id="newFlightLogObservations"></textarea>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button type="submit">Agregar</button>
                        <button type="button" onclick="hideModal()">Cancelar</button>
                    </div>
                </form>
            `;
            
            showModal(formHtml);
        }
        
        // Agregar libro de vuelo
        async function addFlightLog() {
            alert('Función de agregar libro de vuelo en desarrollo');
        }
        
        // Mostrar formulario para solicitar certificación
        function showAddRequestForm() {
            const formHtml = `
                <h2>Solicitar Certificación</h2>
                <form onsubmit="event.preventDefault(); addRequest()">
                    <div class="form-group">
                        <label for="newRequestAircraft">Aeronave</label>
                        <select id="newRequestAircraft" required>
                            <option value="">Seleccionar aeronave</option>
                            <!-- Las opciones se cargarán dinámicamente -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="newRequestAvailability">Disponibilidad</label>
                        <textarea id="newRequestAvailability" required placeholder="Ejemplo: Lunes a Viernes de 14:00 a 18:00"></textarea>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="newRequestAgreement" required>
                            He leído y acepto la carta de compromiso
                        </label>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button type="submit">Enviar Solicitud</button>
                        <button type="button" onclick="hideModal()">Cancelar</button>
                    </div>
                </form>
            `;
            
            showModal(formHtml);
        }
        
        // Agregar solicitud
        async function addRequest() {
            alert('Función de agregar solicitud en desarrollo');
        }
        
        // Mostrar formulario para agregar rango
        function showAddRankForm() {
            const formHtml = `
                <h2>Agregar Rango</h2>
                <form onsubmit="event.preventDefault(); addRank()">
                    <div class="form-group">
                        <label for="newRankName">Nombre del rango</label>
                        <input type="text" id="newRankName" required>
                    </div>
                    <div class="form-group">
                        <label for="newRankAbbreviation">Abreviación</label>
                        <input type="text" id="newRankAbbreviation" required>
                    </div>
                    <div class="form-group">
                        <label for="newRankLevel">Escalafón</label>
                        <input type="number" id="newRankLevel" required min="1">
                    </div>
                    <div class="form-group">
                        <label for="newRankPhoto">URL de la insignia</label>
                        <input type="url" id="newRankPhoto">
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button type="submit">Agregar</button>
                        <button type="button" onclick="hideModal()">Cancelar</button>
                    </div>
                </form>
            `;
            
            showModal(formHtml);
        }
        
        // Agregar rango
        async function addRank() {
            alert('Función de agregar rango en desarrollo');
        }

        // Inicialización
        document.addEventListener('DOMContentLoaded', function() {
            // Verificar si ya hay una sesión activa
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                showView('mainView');
                loadAllData();
            }
        });
    </script>
</body>
</html>
