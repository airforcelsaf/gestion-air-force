<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Air Force Pilots Registry</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
  :root{--bg:#0f1724;--card:#0b1220;--muted:#9aa4b2;--accent:#4f46e5}
  body{font-family:Inter,system-ui,Segoe UI,Arial;background:linear-gradient(180deg,#071026 0%, #081226 100%);color:#e6eef8;margin:0;padding:24px}
  .container{max-width:1000px;margin:0 auto}
  header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
  h1{font-size:20px;margin:0}
  .card{background:rgba(255,255,255,0.03);padding:16px;border-radius:12px;box-shadow:0 6px 18px rgba(2,6,23,.6)}
  .grid{display:grid;grid-template-columns:1fr 340px;gap:16px}
  input,select,button,textarea{font-family:inherit;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:inherit}
  label{display:block;margin-bottom:6px;font-weight:600;color:var(--muted);font-size:13px}
  .list{margin-top:12px}
  .pilot-row{display:flex;align-items:center;justify-content:space-between;padding:8px;border-radius:8px;margin-bottom:8px;background:rgba(255,255,255,0.02)}
  .pilot-info{display:flex;align-items:center;gap:12px}
  .pilot-avatar{width:44px;height:44px;border-radius:8px;background:linear-gradient(180deg,#0b1220,#021022);display:flex;align-items:center;justify-content:center;font-weight:700}
  .small{font-size:13px;color:var(--muted)}
  .btn{padding:8px 12px;border-radius:8px;border:none;background:var(--accent);color:white;cursor:pointer}
  .muted{color:var(--muted)}
  .badge{width:36px;height:36px;display:flex;align-items:center;justify-content:center;border-radius:6px;background:rgba(255,255,255,0.02)}
  .hidden{display:none}
  .column{display:flex;flex-direction:column}
  .rank-svgs img{width:28px;height:28px}
  .login-wrap{max-width:420px;margin:28px auto}
  footer{margin-top:18px;color:var(--muted);font-size:13px;text-align:center}
  .tabs{display:flex;gap:6px;margin-top:8px}
  .tab{padding:6px 10px;border-radius:8px;background:rgba(255,255,255,0.02);cursor:pointer}
  .active-tab{background:rgba(79,70,229,0.13);border:1px solid rgba(79,70,229,0.12)}
  @media(max-width:880px){.grid{grid-template-columns:1fr}}
</style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Air Force — Pilots Registry</h1>
      <div class="small muted">Repo: GitHub Pages • Backend: Google Apps Script (Sheets)</div>
    </header>

    <!-- LOGIN -->
    <div id="login" class="card login-wrap">
      <h2 style="margin:0 0 8px 0">Iniciar sesión</h2>
      <div class="column">
        <label for="email">Correo</label>
        <input id="email" placeholder="ejemplo@airforce.org" />
        <label for="password" style="margin-top:8px">Contraseña</label>
        <input id="password" type="password" placeholder="contraseña" />
        <div style="display:flex;gap:8px;margin-top:12px">
          <button id="btnLogin" class="btn">Entrar</button>
          <button id="btnDemo" class="btn" style="background:#2b3750">Modo demo</button>
        </div>
        <p class="muted small" style="margin-top:10px">Si aún no tienes API configurada, usa <strong>Modo demo</strong>.</p>
      </div>
    </div>

    <!-- APP -->
    <div id="app" class="hidden">
      <div class="grid">
        <div>
          <div class="card">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div>
                <strong id="userLabel">Usuario</strong>
                <div class="small muted" id="userEmail"></div>
              </div>
              <div>
                <button id="btnLogout" class="btn" style="background:#233044">Cerrar sesión</button>
              </div>
            </div>

            <div style="margin-top:12px">
              <h3 style="margin:0 0 8px 0">Registrar piloto</h3>
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
                <div>
                  <label>Nombre</label><input id="p_name" />
                </div>
                <div>
                  <label>NUIM</label><input id="p_nuim" />
                </div>
                <div>
                  <label>Correo</label><input id="p_email" />
                </div>
                <div>
                  <label>Nacionalidad</label><input id="p_nationality" />
                </div>
                <div>
                  <label>Tipo de sangre</label><input id="p_blood" />
                </div>
                <div>
                  <label>Rango</label>
                  <select id="p_rank">
                    <option>Soldado</option>
                    <option>Cabo</option>
                    <option>Teniente</option>
                    <option>Capitán</option>
                    <option>Mayor</option>
                    <option>Coronel</option>
                  </select>
                </div>
                <div style="grid-column:1/3">
                  <label>URL Foto (opcional)</label><input id="p_photo" />
                </div>
              </div>
              <div style="margin-top:10px;display:flex;gap:8px">
                <button id="btnAddPilot" class="btn">Agregar piloto</button>
                <button id="btnRefresh" class="btn" style="background:#2b3750">Actualizar lista</button>
              </div>
            </div>
          </div>

          <div class="card" style="margin-top:12px">
            <h3 style="margin:0 0 8px 0">Lista de pilotos</h3>
            <div id="pilotsList" class="list"></div>
          </div>
        </div>

        <!-- Right column: Profile -->
        <div>
          <div id="profileCard" class="card">
            <div id="noSelection">
              <div class="small muted">Selecciona un piloto para ver su ficha.</div>
            </div>
            <div id="profile" class="hidden">
              <div style="display:flex;gap:12px;align-items:center">
                <div class="pilot-avatar" id="profileAvatar">P</div>
                <div>
                  <div style="font-size:18px;font-weight:700" id="profileName">Nombre</div>
                  <div class="small muted" id="profileRank">Rango</div>
                </div>
                <div style="margin-left:auto;text-align:right">
                  <div class="small muted">NUIM</div>
                  <div id="profileNUIM" style="font-weight:700"></div>
                </div>
              </div>

              <div style="margin-top:12px">
                <div class="small muted">Nacionalidad</div>
                <div id="profileNationality"></div>
                <div class="small muted" style="margin-top:8px">Tipo de sangre</div>
                <div id="profileBlood"></div>
                <div class="small muted" style="margin-top:8px">Correo</div>
                <div id="profileEmail"></div>
              </div>

              <div style="margin-top:12px">
                <div class="tabs">
                  <div class="tab active-tab" data-tab="ranks">Ascensos / Descensos</div>
                  <div class="tab" data-tab="flightlogs">Libros de vuelo</div>
                </div>

                <div id="tabContent" style="margin-top:10px">
                  <!-- ranks -->
                  <div id="ranksTab">
                    <div id="ranksList" class="list small muted">Cargando...</div>
                    <div style="margin-top:8px">
                      <label>Agregar cambio (ascenso/descenso)</label>
                      <div style="display:flex;gap:8px">
                        <select id="rankType"><option value="ascenso">Ascenso</option><option value="descenso">Descenso</option></select>
                        <input id="rankAfter" placeholder="Rango resultante" />
                        <input id="rankDate" type="date" />
                        <button id="btnAddRank" class="btn">Agregar</button>
                      </div>
                    </div>
                  </div>

                  <!-- flightlogs -->
                  <div id="flightlogsTab" class="hidden">
                    <div id="flightlogsList" class="list small muted">Cargando...</div>
                    <div style="margin-top:8px">
                      <label>Subir libro de vuelo (registro)</label>
                      <div style="display:flex;gap:8px">
                        <input id="fl_file_name" placeholder="Nombre del archivo" />
                        <input id="fl_url" placeholder="URL (opcional)" />
                        <button id="btnAddFlightLog" class="btn">Agregar</button>
                      </div>
                    </div>
                  </div>

                </div>
              </div>
            </div>
          </div>

          <div class="card" style="margin-top:12px">
            <div class="small muted">Ajustes</div>
            <div style="margin-top:8px;display:flex;gap:8px">
              <button id="btnClearDemo" class="btn" style="background:#6b1e3a">Borrar demo</button>
              <button id="btnShowAPI" class="btn" style="background:#1f3a2f">Mostrar API URL</button>
            </div>
            <div id="apiInfo" class="muted small" style="margin-top:8px"></div>
          </div>
        </div>
      </div>
    </div>

    <footer>Hecho para registro de pilotos • Sube a GitHub y activa tu Apps Script</footer>
  </div>

<script>
/*
  CONFIG
  - Si pones tu API_URL (Google Apps Script Web App URL) el front usará la API real.
  - Si lo dejas vacío, funcionará en modo DEMO usando localStorage.
*/
const API_URL = 'https://script.google.com/macros/s/AKfycbyrJBRKzdB5U2HDs85zGoGFnhXSUV1DSOG6fAnq7v43NB01OCsremjywhCkyHZLZ-5b/exec'; // <- pega aquí la URL de tu Google Apps Script después de deploy

// Rango a insignia mapping (pequeños svgs embebidos)
const RANK_BADGES = {
  'Soldado': `<svg viewBox="0 0 24 24" width="28" height="28"><rect width="20" height="14" x="2" y="5" rx="2" fill="#e6eef8" opacity="0.12"/><text x="12" y="15" font-size="10" fill="#e6eef8" text-anchor="middle">S</text></svg>`,
  'Cabo': `<svg viewBox="0 0 24 24" width="28" height="28"><rect width="20" height="14" x="2" y="5" rx="2" fill="#e6eef8" opacity="0.12"/><text x="12" y="15" font-size="10" fill="#e6eef8" text-anchor="middle">C</text></svg>`,
  'Teniente': `<svg viewBox="0 0 24 24" width="28" height="28"><circle cx="12" cy="11" r="7" fill="#e6eef8" opacity="0.12"/><text x="12" y="14" font-size="9" fill="#e6eef8" text-anchor="middle">T</text></svg>`,
  'Capitán': `<svg viewBox="0 0 24 24" width="28" height="28"><rect x="4" y="6" width="16" height="10" rx="3" fill="#e6eef8" opacity="0.12"/><text x="12" y="14" font-size="9" fill="#e6eef8" text-anchor="middle">CPT</text></svg>`,
  'Mayor': `<svg viewBox="0 0 24 24" width="28" height="28"><polygon points="12,3 3,21 21,21" fill="#e6eef8" opacity="0.12"/><text x="12" y="16" font-size="9" fill="#e6eef8" text-anchor="middle">M</text></svg>`,
  'Coronel': `<svg viewBox="0 0 24 24" width="28" height="28"><path d="M2 6h20v12H2z" fill="#e6eef8" opacity="0.12"/><text x="12" y="15" font-size="9" fill="#e6eef8" text-anchor="middle">COL</text></svg>`
};

// ---------- Utilities ----------
function el(id){return document.getElementById(id)}
function show(sel){sel.classList.remove('hidden')}
function hide(sel){sel.classList.add('hidden')}
function q(selector){return document.querySelector(selector)}

async function apiFetch(path, method='GET', body=null) {
  if (!API_URL) {
    // in demo mode, handle locally
    return demoApi(path, method, body);
  }
  const url = API_URL + '?path=' + encodeURIComponent(path);
  const opts = { method: method };
  if (body) {
    opts.headers = {'Content-Type':'application/json'};
    opts.body = JSON.stringify(body);
  }
  const res = await fetch(url, opts);
  return res.json();
}

// ---------- Demo (localStorage) ----------
function demoData() {
  const base = localStorage.getItem('pilots_app_demo');
  if (base) return JSON.parse(base);
  const initial = {
    users: [{id:'U-1', email:'admin@airforce.org', password:'1234', name:'Admin', created_at:new Date().toISOString()}],
    pilots: [],
    ranks: [],
    flightlogs: []
  };
  localStorage.setItem('pilots_app_demo', JSON.stringify(initial));
  return initial;
}
function saveDemo(d){ localStorage.setItem('pilots_app_demo', JSON.stringify(d)); }
async function demoApi(path, method, body) {
  const d = demoData();
  if (path === 'login') {
    const u = d.users.find(x => x.email.toLowerCase() === (body.email||'').toLowerCase() && x.password === body.password);
    return {ok: !!u, user: u || null, error: u?null:'invalid_credentials'};
  }
  if (path === 'getpilots') {
    return {ok:true, pilots: d.pilots};
  }
  if (path === 'addpilot') {
    const id = 'P-' + String(d.pilots.length + 1).padStart(4,'0');
    const obj = Object.assign({id, created_at: new Date().toISOString()}, body);
    d.pilots.push(obj); saveDemo(d);
    return {ok:true, pilot: obj};
  }
  if (path === 'getpilot') {
    const p = d.pilots.find(x => x.id === body.id);
    return {ok: !!p, pilot: p || null, error: p?null:'pilot_not_found'};
  }
  if (path === 'addrank') {
    const id = 'RH-' + String(d.ranks.length + 1).padStart(4,'0');
    const obj = Object.assign({id, created_at: new Date().toISOString()}, body);
    d.ranks.push(obj); saveDemo(d);
    return {ok:true, rank: obj};
  }
  if (path === 'getranks') {
    const list = d.ranks.filter(x => x.pilot_id === body.pilot_id);
    return {ok:true, ranks: list};
  }
  if (path === 'addflightlog') {
    const id = 'FL-' + String(d.flightlogs.length + 1).padStart(4,'0');
    const obj = Object.assign({id, created_at: new Date().toISOString()}, body);
    d.flightlogs.push(obj); saveDemo(d);
    return {ok:true, flightlog: obj};
  }
  if (path === 'getflightlogs') {
    const list = d.flightlogs.filter(x => x.pilot_id === body.pilot_id);
    return {ok:true, flight_logs: list, count: list.length};
  }
  return {ok:false, error:'unknown_demo_endpoint'};
}

// ---------- App State ----------
let currentUser = null;
let pilotsCache = [];

// ---------- UI wiring ----------
el('btnDemo').addEventListener('click', async () => {
  // Log in demo user automatically
  const res = await apiFetch('login','POST',{email:'admin@airforce.org',password:'1234'});
  if (res.ok) {
    currentUser = res.user;
    afterLogin();
  } else {
    // create demo admin if not exists
    const d = demoData();
    if (!d.users.find(u=>u.email==='admin@airforce.org')) {
      d.users.push({id:'U-1',email:'admin@airforce.org',password:'1234',name:'Admin',created_at:new Date().toISOString()});
      saveDemo(d);
    }
    const res2 = await apiFetch('login','POST',{email:'admin@airforce.org',password:'1234'});
    currentUser = res2.user; afterLogin();
  }
});

el('btnLogin').addEventListener('click', async ()=>{
  const email = el('email').value.trim();
  const password = el('password').value;
  if (!email || !password) return alert('Ingresa correo y contraseña');
  const res = await apiFetch('login','POST',{email,password});
  if (!res.ok) return alert('Credenciales inválidas');
  currentUser = res.user; afterLogin();
});

function afterLogin(){
  hide(el('login'));
  show(el('app'));
  el('userLabel').innerText = currentUser.name || currentUser.email;
  el('userEmail').innerText = currentUser.email || '';
  loadPilots();
  document.title = 'AF Registry — ' + (currentUser.name || currentUser.email);
  el('apiInfo').innerText = API_URL ? ('API: ' + API_URL) : 'Modo demo (localStorage)';
}

el('btnLogout').addEventListener('click', ()=>{
  currentUser = null;
  hide(el('app'));
  show(el('login'));
  document.title = 'Air Force Pilots Registry';
});

el('btnAddPilot').addEventListener('click', async ()=>{
  const payload = {
    name: el('p_name').value.trim(),
    nuim: el('p_nuim').value.trim(),
    email: el('p_email').value.trim(),
    nationality: el('p_nationality').value.trim(),
    blood_type: el('p_blood').value.trim(),
    rank: el('p_rank').value,
    photo_url: el('p_photo').value.trim()
  };
  if (!payload.name) return alert('Nombre es requerido');
  const res = await apiFetch('addpilot','POST',payload);
  if (!res.ok) return alert('Error agregando piloto: ' + (res.error||''));
  clearPilotForm();
  alert('Piloto agregado: ' + res.pilot.id);
  loadPilots();
});

el('btnRefresh').addEventListener('click', loadPilots);

function clearPilotForm(){
  ['p_name','p_nuim','p_email','p_nationality','p_blood','p_photo'].forEach(id=>el(id).value='');
}

async function loadPilots(){
  el('pilotsList').innerHTML = 'Cargando...';
  const res = await apiFetch('getpilots','GET',null);
  if (!res.ok) { el('pilotsList').innerHTML = 'Error cargando pilotos'; return; }
  pilotsCache = res.pilots || [];
  if (pilotsCache.length === 0) el('pilotsList').innerHTML = '<div class="muted">No hay pilotos registrados.</div>';
  else {
    el('pilotsList').innerHTML = '';
    pilotsCache.forEach(p => {
      const div = document.createElement('div');
      div.className = 'pilot-row';
      div.innerHTML = `
        <div class="pilot-info">
          <div class="pilot-avatar">${getInitials(p.name)}</div>
          <div>
            <div style="font-weight:700">${p.name}</div>
            <div class="small muted">${p.nationality || ''}</div>
          </div>
        </div>
        <div style="display:flex;align-items:center;gap:8px">
          <div class="badge rank-svgs" title="${p.rank || ''}">${getBadge(p.rank)}</div>
          <button class="btn" data-id="${p.id}">Ver</button>
        </div>
      `;
      el('pilotsList').appendChild(div);
      div.querySelector('button').addEventListener('click', ()=>selectPilot(p.id));
    });
  }
}

function getInitials(name=''){
  const parts = name.split(' ').filter(Boolean);
  if (parts.length ===0) return 'P';
  if (parts.length ===1) return parts[0].slice(0,2).toUpperCase();
  return (parts[0][0] + parts[1][0]).toUpperCase();
}
function getBadge(rank){
  return (RANK_BADGES[rank] || `<div style="font-size:12px;color:var(--muted)">—</div>`);
}

async function selectPilot(id){
  const res = await apiFetch('getpilot','POST',{id});
  if (!res.ok) return alert('No encontrado');
  const p = res.pilot;
  hide(el('noSelection'));
  show(el('profile'));
  el('profileAvatar').innerHTML = p.photo_url ? `<img src="${p.photo_url}" alt="foto" style="width:44px;height:44px;border-radius:8px;object-fit:cover">` : getInitials(p.name);
  el('profileName').innerText = p.name;
  el('profileRank').innerText = p.rank;
  el('profileNUIM').innerText = p.nuim || '-';
  el('profileNationality').innerText = p.nationality || '-';
  el('profileBlood').innerText = p.blood_type || '-';
  el('profileEmail').innerText = p.email || '-';

  // cargar tabs content
  loadRanks(p.id);
  loadFlightLogs(p.id);
  // attach add rank/flight log functions with pilot id
  el('btnAddRank').onclick = async () => {
    const payload = {
      pilot_id: p.id,
      type: el('rankType').value,
      rank_after: el('rankAfter').value || el('profileRank').innerText,
      date: el('rankDate').value || new Date().toISOString().slice(0,10),
      note: ''
    };
    const res = await apiFetch('addrank','POST',payload);
    if (!res.ok) return alert('Error');
    alert('Registro guardado');
    el('rankAfter').value=''; el('rankDate').value='';
    loadRanks(p.id);
    loadPilots();
  };
  el('btnAddFlightLog').onclick = async () => {
    const payload = {
      pilot_id: p.id,
      file_name: el('fl_file_name').value || ('Libro ' + new Date().toISOString().slice(0,10)),
      url: el('fl_url').value || '',
      upload_date: new Date().toISOString().slice(0,10)
    };
    const res = await apiFetch('addflightlog','POST',payload);
    if (!res.ok) return alert('Error');
    alert('Libro agregado');
    el('fl_file_name').value=''; el('fl_url').value='';
    loadFlightLogs(p.id);
  };
}

async function loadRanks(pilot_id){
  el('ranksList').innerHTML = 'Cargando...';
  const res = await apiFetch('getranks','POST',{pilot_id});
  if (!res.ok) { el('ranksList').innerHTML = 'Error'; return; }
  const arr = res.ranks || [];
  if (arr.length === 0) el('ranksList').innerHTML = '<div class="muted small">Sin movimientos</div>';
  else {
    el('ranksList').innerHTML = '';
    arr.slice().reverse().forEach(r=>{
      const div = document.createElement('div');
      div.className = 'pilot-row';
      div.innerHTML = `<div><div style="font-weight:700">${r.type.toUpperCase()} — ${r.rank_after}</div><div class="small muted">${r.date || ''}</div></div>
                       <div class="badge">${getBadge(r.rank_after)}</div>`;
      el('ranksList').appendChild(div);
    });
  }
}

async function loadFlightLogs(pilot_id){
  el('flightlogsList').innerHTML = 'Cargando...';
  const res = await apiFetch('getflightlogs','POST',{pilot_id});
  if (!res.ok) { el('flightlogsList').innerHTML = 'Error'; return; }
  const arr = res.flight_logs || [];
  if (arr.length === 0) el('flightlogsList').innerHTML = '<div class="muted small">Sin libros de vuelo</div>';
  else {
    el('flightlogsList').innerHTML = '';
    arr.forEach(f=>{
      const div = document.createElement('div');
      div.className = 'pilot-row';
      const urlLink = f.url ? `<a class="small muted" href="${f.url}" target="_blank">Ver</a>` : '';
      div.innerHTML = `<div><div style="font-weight:700">${f.file_name}</div><div class="small muted">${f.upload_date}</div></div>
                       <div>${urlLink}<div class="small muted">#${f.id}</div></div>`;
      el('flightlogsList').appendChild(div);
    });
  }
}

// Tabs
document.querySelectorAll('.tab').forEach(t=>{
  t.addEventListener('click', ()=> {
    document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active-tab'));
    t.classList.add('active-tab');
    const key = t.dataset.tab;
    if (key === 'ranks') { hide(el('flightlogsTab')); show(el('ranksTab')); }
    else { hide(el('ranksTab')); show(el('flightlogsTab')); }
  });
});

// small utilities/buttons
el('btnClearDemo').addEventListener('click', ()=>{ if(confirm('Borrar datos demo?')){ localStorage.removeItem('pilots_app_demo'); alert('Demo borrado'); }});
el('btnShowAPI').addEventListener('click', ()=>{ alert(API_URL ? 'API: ' + API_URL : 'API no configurada. Modo demo activo.'); });

// On load: If API_URL empty show login, else also show login waiting for credentials
document.addEventListener('DOMContentLoaded', ()=>{
  // nothing special
});
</script>
</body>
</html>
