<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema LSAF - Fuerza Aérea</title>
    <style>
        /* Estilos mínimos pero funcionales */
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #f5f5f5; }
        .login-container { display: flex; justify-content: center; align-items: center; height: 100vh; }
        .login-form { background: white; padding: 2rem; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); max-width: 400px; width: 100%; }
        .form-group { margin-bottom: 1rem; }
        label { display: block; margin-bottom: 0.5rem; font-weight: bold; }
        input, select, button { width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; }
        button { background: #00308F; color: white; border: none; cursor: pointer; font-weight: bold; }
        button:hover { background: #002244; }
        .app-container { display: none; }
        .nav-tabs { background: #5072A7; display: flex; padding: 0; }
        .nav-tab { padding: 1rem; color: white; cursor: pointer; }
        .nav-tab.active { background: white; color: #00308F; }
        .page { display: none; padding: 1rem; background: white; margin-top: 1rem; border-radius: 4px; }
        .page.active { display: block; }
        .card { background: white; padding: 1rem; margin-bottom: 1rem; border-radius: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .error { color: red; }
        .success { color: green; }
    </style>
</head>
<body>
    <div class="login-container" id="loginPage">
        <div class="login-form">
            <h2>Sistema LSAF - Login</h2>
            <form id="loginForm">
                <div class="form-group">
                    <label>Email:</label>
                    <input type="email" id="email" value="david_toro@lsaf.gov.us" required>
                </div>
                <div class="form-group">
                    <label>Contraseña:</label>
                    <input type="password" id="password" required>
                </div>
                <button type="submit">Iniciar Sesión</button>
                <div id="loginMessage"></div>
            </form>
            <p><strong>Nota:</strong> Usa las credenciales de tu base de datos real</p>
        </div>
    </div>

    <div class="app-container" id="appContainer">
        <header style="background: #00308F; color: white; padding: 1rem;">
            <h1>Fuerza Aérea LSAF</h1>
            <div>
                <span id="userName">Usuario</span>
                <button onclick="logout()" style="margin-left: 1rem;">Cerrar sesión</button>
            </div>
        </header>
        
        <nav class="nav-tabs">
            <div class="nav-tab active" onclick="showPage('pilotos')">Pilotos</div>
            <div class="nav-tab" onclick="showPage('aeronaves')">Aeronaves</div>
        </nav>
        
        <div id="pilotosPage" class="page active">
            <div class="card">
                <h2>Gestión de Pilotos</h2>
                <button onclick="showPilotoForm()">Agregar Piloto</button>
                <div id="pilotosList">Cargando...</div>
            </div>
        </div>
        
        <div id="aeronavesPage" class="page">
            <div class="card">
                <h2>Gestión de Aeronaves</h2>
                <div id="aeronavesList">Cargando...</div>
            </div>
        </div>
    </div>

    <!-- Modal para agregar/editar piloto -->
    <div id="pilotoModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center;">
        <div style="background: white; padding: 2rem; border-radius: 8px; width: 90%; max-width: 500px;">
            <h3 id="modalTitle">Agregar Piloto</h3>
            <form id="pilotoForm">
                <input type="hidden" id="editNuim">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label>Nombre:</label>
                        <input type="text" id="pilotoNombre" required>
                    </div>
                    <div class="form-group">
                        <label>Email:</label>
                        <input type="email" id="pilotoEmail" required>
                    </div>
                    <div class="form-group">
                        <label>NUIM:</label>
                        <input type="text" id="pilotoNUIM" required>
                    </div>
                    <div class="form-group">
                        <label>Rol:</label>
                        <select id="pilotoRol" required>
                            <option value="PILOTO">PILOTO</option>
                            <option value="INSTRUCTOR">INSTRUCTOR</option>
                            <option value="ADMIN">ADMIN</option>
                        </select>
                    </div>
                </div>
                <div style="margin-top: 1rem;">
                    <button type="submit">Guardar</button>
                    <button type="button" onclick="hideModal()" style="background: #666;">Cancelar</button>
                </div>
                <div id="modalMessage"></div>
            </form>
        </div>
    </div>

    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbzZXQH3gmjtcZMmbDIzmfyAZTZ_zjSCQnInosFyoQj5VH0Gyx5rXW2bqwMOGfCF5ENDwA/exec';
        let currentUser = null;
        let pilotos = [];

        // Login
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            try {
                const response = await fetch(`${API_URL}?action=login&email=${email}&password=${password}`);
                const data = await response.json();
                
                if (data.success) {
                    currentUser = data.user;
                    localStorage.setItem('lsaf_user', JSON.stringify(currentUser));
                    showApp();
                } else {
                    showMessage('loginMessage', data.error, 'error');
                }
            } catch (error) {
                showMessage('loginMessage', 'Error de conexión', 'error');
            }
        });

        // Cargar datos al iniciar
        if (localStorage.getItem('lsaf_user')) {
            currentUser = JSON.parse(localStorage.getItem('lsaf_user'));
            showApp();
        }

        function showApp() {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('appContainer').style.display = 'block';
            document.getElementById('userName').textContent = currentUser.nombre;
            loadPilotos();
        }

        function logout() {
            localStorage.removeItem('lsaf_user');
            location.reload();
        }

        function showPage(page) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.getElementById(page + 'Page').classList.add('active');
            event.target.classList.add('active');
        }

        async function loadPilotos() {
            try {
                const response = await fetch(`${API_URL}?action=getPilotos`);
                const data = await response.json();
                
                if (data.error) throw new Error(data.error);
                
                pilotos = data.pilotos;
                displayPilotos();
            } catch (error) {
                document.getElementById('pilotosList').innerHTML = `<p class="error">Error: ${error.message}</p>`;
            }
        }

        function displayPilotos() {
            const list = document.getElementById('pilotosList');
            list.innerHTML = '<h3>Lista de Pilotos</h3>';
            
            if (pilotos.length === 0) {
                list.innerHTML += '<p>No hay pilotos registrados</p>';
                return;
            }
            
            pilotos.forEach(piloto => {
                list.innerHTML += `
                    <div style="border: 1px solid #ddd; padding: 1rem; margin: 0.5rem 0; border-radius: 4px;">
                        <strong>${piloto.nombre}</strong> - ${piloto.nuim} - ${piloto.rol}
                        <button onclick="editPiloto('${piloto.nuim}')">Editar</button>
                    </div>
                `;
            });
        }

        function showPilotoForm() {
            document.getElementById('modalTitle').textContent = 'Agregar Piloto';
            document.getElementById('pilotoForm').reset();
            document.getElementById('editNuim').value = '';
            document.getElementById('pilotoModal').style.display = 'flex';
        }

        function editPiloto(nuim) {
            const piloto = pilotos.find(p => p.nuim === nuim);
            if (piloto) {
                document.getElementById('modalTitle').textContent = 'Editar Piloto';
                document.getElementById('pilotoNombre').value = piloto.nombre;
                document.getElementById('pilotoEmail').value = piloto.correo;
                document.getElementById('pilotoNUIM').value = piloto.nuim;
                document.getElementById('pilotoRol').value = piloto.rol;
                document.getElementById('editNuim').value = piloto.nuim;
                document.getElementById('pilotoModal').style.display = 'flex';
            }
        }

        function hideModal() {
            document.getElementById('pilotoModal').style.display = 'none';
        }

        document.getElementById('pilotoForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const isEdit = document.getElementById('editNuim').value !== '';
            const formData = {
                nombre: document.getElementById('pilotoNombre').value,
                email: document.getElementById('pilotoEmail').value,
                nuim: document.getElementById('pilotoNUIM').value,
                rol: document.getElementById('pilotoRol').value,
                estado: 'ACTIVO',
                fecha_ingreso: new Date().toISOString().split('T')[0]
            };
            
            if (isEdit) {
                formData.nuim_original = document.getElementById('editNuim').value;
            }
            
            try {
                const action = isEdit ? 'updatePiloto' : 'addPiloto';
                const params = new URLSearchParams(formData);
                const response = await fetch(`${API_URL}?action=${action}&${params}`);
                const data = await response.json();
                
                if (data.success) {
                    showMessage('modalMessage', data.message, 'success');
                    setTimeout(() => {
                        hideModal();
                        loadPilotos();
                    }, 1000);
                } else {
                    showMessage('modalMessage', data.error, 'error');
                }
            } catch (error) {
                showMessage('modalMessage', 'Error de conexión', 'error');
            }
        });

        function showMessage(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = type;
        }
    </script>
</body>
</html>
